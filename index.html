<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PropCalc Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc; --card: #fff; --border: #e2e8f0;
      --text: #1e293b; --text-muted: #64748b; --text-light: #94a3b8;
      --primary: #10b981; --primary-dark: #059669;
      --accent: #3b82f6; --accent-dark: #1e40af;
      --highlight: #0f172a; --highlight-text: #10b981;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); font-size: 13px; line-height: 1.4; }

    /* Header */
    .header { background: var(--card); border-bottom: 1px solid var(--border); padding: 8px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 15px; }
    .logo-icon { width: 28px; height: 28px; background: var(--highlight); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 14px; }
    .vault-select { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); cursor: pointer; font-size: 13px; }
    .header-actions { display: flex; gap: 8px; }
    .btn { padding: 6px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 5px; transition: all 0.15s; }
    .btn-save { background: var(--primary); color: #fff; }
    .btn-save:hover { background: var(--primary-dark); }
    .btn-pdf { background: var(--card); border: 1px solid var(--border); color: var(--text); }
    .btn-pdf:hover { background: var(--bg); }
    .btn-new { background: var(--accent); color: #fff; }
    .btn-new:hover { background: var(--accent-dark); }
    .btn-delete { background: #ef4444; color: #fff; }
    .btn-delete:hover { background: #dc2626; }

    /* Main Layout */
    .main { display: grid; grid-template-columns: 33% 1fr; gap: 20px; padding: 20px; }

    /* Cards */
    .card { background: var(--card); border-radius: 10px; border: 1px solid var(--border); padding: 14px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
    .card-header svg { width: 14px; height: 14px; margin-right: 6px; }
    .badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; background: var(--bg); color: var(--text-muted); }

    /* Inputs */
    .input-row { display: grid; gap: 10px; margin-bottom: 10px; }
    .input-row.cols-2 { grid-template-columns: 1fr 1fr; }
    .input-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .input-group { display: flex; flex-direction: column; gap: 3px; }
    .input-group label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.3px; }
    .input-wrap { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; background: var(--card); }
    .input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16,185,129,0.1); }
    .input-prefix { padding: 6px 8px; background: var(--bg); color: var(--text-muted); font-size: 12px; border-right: 1px solid var(--border); }
    .input-wrap input { border: none; padding: 6px 8px; width: 100%; font-size: 13px; outline: none; }

    /* Highlight Box */
    .highlight-box { background: var(--highlight); color: #fff; border-radius: 8px; padding: 12px; margin: 10px 0; }
    .highlight-box .label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #ef4444; margin-bottom: 4px; }
    .highlight-box .value { font-size: 26px; font-weight: 700; color: #fff; }
    .highlight-box .breakdown { display: flex; gap: 12px; margin-top: 8px; font-size: 11px; }
    .highlight-box .breakdown span { color: var(--text-light); }
    .highlight-box .breakdown strong { color: #fff; margin-left: 4px; }

    /* Revenue Box */
    .revenue-box { background: var(--highlight); color: var(--highlight-text); border-radius: 8px; padding: 10px; }
    .revenue-box .label { font-size: 10px; text-transform: uppercase; color: var(--text-light); }
    .revenue-box .value { font-size: 22px; font-weight: 700; }

    /* Metrics Bar */
    .metrics-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .metric { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; }
    .metric.highlight { background: var(--highlight); border-color: var(--highlight); }
    .metric .label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.3px; display: flex; align-items: center; justify-content: center; gap: 4px; }
    .metric.highlight .label { color: var(--text-light); }
    .metric .value { font-size: 20px; font-weight: 700; margin-top: 2px; }
    .metric.highlight .value { color: var(--highlight-text); }
    .metric .sub { font-size: 9px; color: var(--text-light); text-transform: uppercase; }

    /* Units Grid */
    .units-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .unit-box { background: var(--bg); border-radius: 6px; padding: 10px; }
    .unit-box .unit-title { font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
    .unit-box .input-group { margin-bottom: 6px; }
    .unit-box .input-group:last-child { margin-bottom: 0; }

    /* Bottom Row */
    .bottom-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 10px; }

    /* Expenses Table */
    .expenses-table { width: 100%; border-collapse: collapse; }
    .expenses-table th { font-size: 10px; text-transform: uppercase; color: var(--text-muted); font-weight: 500; padding: 6px 4px; text-align: left; border-bottom: 1px solid var(--border); }
    .expenses-table td { padding: 8px 4px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .expenses-table .expense-name { font-weight: 500; }
    .expenses-table .expense-input { width: 100px; }
    .expenses-table .expense-yearly { text-align: right; font-weight: 600; color: var(--text); }

    /* Toggle Buttons */
    .toggle-group { display: inline-flex; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
    .toggle-btn { padding: 3px 8px; font-size: 10px; border: none; background: var(--card); cursor: pointer; color: var(--text-muted); }
    .toggle-btn.active { background: var(--highlight); color: #fff; }

    /* Expense Total */
    .expense-total { background: var(--highlight); color: #fff; border-radius: 8px; padding: 10px 14px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
    .expense-total .label { font-size: 10px; text-transform: uppercase; }
    .expense-total .value { font-size: 18px; font-weight: 700; color: var(--primary); }

    /* Columns */
    .left-col { display: flex; flex-direction: column; gap: 16px; }
    .right-col { display: flex; flex-direction: column; gap: 16px; }

    /* Milestones */
    .milestones { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .milestone { background: var(--bg); border-radius: 8px; padding: 12px; }
    .milestone-header { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; }
    .milestone-header svg { width: 16px; height: 16px; }
    .milestone-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .milestone-row .label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); }
    .milestone-row .value { font-size: 14px; font-weight: 600; }
    .milestone-row .value.green { color: var(--primary); }
    .milestone-row .value.red { color: #ef4444; }
    .net-gain { background: var(--primary); color: #fff; border-radius: 6px; padding: 10px; text-align: center; margin-top: 8px; }
    .net-gain .label { font-size: 10px; text-transform: uppercase; opacity: 0.9; }
    .net-gain .value { font-size: 20px; font-weight: 700; }

    /* Chart */
    .chart-container { flex: 1; min-height: 150px; position: relative; }
    .chart-legend { display: flex; gap: 16px; justify-content: flex-end; font-size: 11px; margin-bottom: 8px; }
    .chart-legend span { display: flex; align-items: center; gap: 6px; }
    .chart-legend .dot { width: 8px; height: 8px; border-radius: 50%; }
    .chart-legend .dot.asset { background: var(--accent); }
    .chart-legend .dot.loan { background: #ef4444; }
    #chart { width: 100%; height: 150px; cursor: crosshair; }

    /* Chart Tooltip */
    .chart-tooltip { position: absolute; background: var(--highlight); color: #fff; padding: 10px 12px; border-radius: 8px; font-size: 11px; pointer-events: none; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.2); white-space: nowrap; display: none; }
    .chart-tooltip.visible { display: block; }
    .chart-tooltip .tt-year { font-size: 12px; font-weight: 600; margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px; }
    .chart-tooltip .tt-row { display: flex; justify-content: space-between; gap: 16px; margin-bottom: 2px; }
    .chart-tooltip .tt-label { color: var(--text-light); }
    .chart-tooltip .tt-value { font-weight: 600; }
    .chart-tooltip .tt-value.asset { color: var(--accent); }
    .chart-tooltip .tt-value.loan { color: #ef4444; }
    .chart-tooltip .tt-value.equity { color: var(--primary); }

    /* Footer */
    .footer { text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px; }
    .footer-logo { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--text); }
    .footer-features { display: flex; justify-content: center; gap: 20px; margin: 8px 0; }
    .footer-features span { display: flex; align-items: center; gap: 4px; }
    .footer-features .check { color: var(--primary); }

    /* Print Styles */
    @media print {
      body { background: #fff; font-size: 11px; }
      .header { position: static; }
      .btn, .vault-select { display: none !important; }
      .main { display: block; padding: 10px; }
      .card { break-inside: avoid; margin-bottom: 10px; border: 1px solid #ddd; }
      .chart-container { height: 140px; }
      @page { size: A4; margin: 10mm; }
    }

    /* Property Name Edit */
    .property-info { display: flex; flex-direction: column; gap: 2px; }
    .property-info input { border: none; background: transparent; padding: 4px 8px; border-radius: 4px; }
    .property-info input:hover { background: var(--bg); }
    .property-info input:focus { background: var(--card); outline: 2px solid var(--primary); }
    .property-info .prop-name { font-size: 14px; font-weight: 600; width: 300px; }
    .property-info .prop-address { font-size: 12px; color: var(--text-muted); width: 300px; }

    /* Mode Tab Toggle */
    .mode-tabs { display: flex; gap: 0; margin-bottom: 4px; }
    .mode-tab { padding: 8px 20px; border: 1px solid var(--border); background: var(--card); cursor: pointer; font-size: 12px; font-weight: 600; color: var(--text-muted); transition: all 0.15s; }
    .mode-tab:first-child { border-radius: 6px 0 0 6px; }
    .mode-tab:last-child { border-radius: 0 6px 6px 0; border-left: none; }
    .mode-tab.active { background: var(--highlight); color: #fff; border-color: var(--highlight); }
    .mode-tab:not(.active):hover { background: var(--bg); }

    /* Mode-specific field visibility */
    .trad-only { display: block; }
    .dscr-only { display: none; }
    body.dscr-mode .trad-only { display: none; }
    body.dscr-mode .dscr-only { display: block; }
    .input-row .trad-only, .input-row .dscr-only { display: flex; flex-direction: column; gap: 3px; }
    body.dscr-mode .input-row .trad-only { display: none; }
    body:not(.dscr-mode) .input-row .dscr-only { display: none; }

    /* DSCR Highlight Box adjustments */
    .highlight-box .breakdown-row { display: flex; gap: 12px; margin-top: 4px; font-size: 11px; flex-wrap: wrap; }
    .highlight-box .breakdown-row span { color: var(--text-light); }
    .highlight-box .breakdown-row strong { color: #fff; margin-left: 4px; }
    .highlight-box .loan-info { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 11px; color: var(--text-light); }
    .highlight-box .label.green { color: var(--primary); }

    /* Duplicate button */
    .btn-duplicate { background: var(--card); border: 1px solid var(--border); color: var(--text); }
    .btn-duplicate:hover { background: var(--bg); }

    /* Carry Modal */
    .carry-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .carry-modal.open { display: flex; }
    .carry-modal-content { background: #fff; border-radius: 12px; padding: 20px; width: 1150px; }
    .carry-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .carry-modal-header h3 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .carry-modal-close { border: none; background: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }
    .carry-modal-close:hover { color: var(--text); }

    .tranche-list { margin-bottom: 8px; }
    .tranche-row { display: grid; grid-template-columns: 1fr 120px 80px 80px 28px 28px; gap: 6px; align-items: center; margin-bottom: 6px; padding: 6px 8px; background: var(--bg); border-radius: 6px; }
    .tranche-row.header { background: none; padding: 0 8px; margin-bottom: 2px; font-size: 9px; text-transform: uppercase; color: var(--text-muted); }
    .tranche-row .max-btn { width: 24px; height: 24px; border: none; background: #dbeafe; color: #2563eb; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 600; display: flex; align-items: center; justify-content: center; }
    .tranche-row .max-btn:hover { background: #bfdbfe; }
    .tranche-row input { padding: 6px 8px; font-size: 12px; }
    .tranche-row .input-group { margin: 0; }
    .tranche-row .remove-btn { width: 24px; height: 24px; border: none; background: #fee2e2; color: #dc2626; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .tranche-row .remove-btn:hover { background: #fecaca; }
    .tranche-row .remove-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .tranche-remainder { font-size: 10px; color: var(--text-muted); padding: 4px 8px; background: var(--card); border: 1px dashed var(--border); border-radius: 4px; }

    .add-tranche-btn { padding: 6px 12px; border: 1px dashed var(--border); background: var(--card); border-radius: 4px; cursor: pointer; font-size: 11px; color: var(--text-muted); width: 100%; margin-bottom: 10px; }
    .add-tranche-btn:hover { background: var(--bg); color: var(--text); }
    .add-tranche-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .carry-summary { background: var(--highlight); color: #fff; border-radius: 6px; padding: 10px; margin-bottom: 10px; font-size: 11px; }
    .carry-summary-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
    .carry-summary-row:last-child { margin-bottom: 0; }
    .carry-summary-row .label { color: rgba(255,255,255,0.8); }
    .carry-summary-row .value { font-weight: 600; }
    .carry-summary-row.total { border-top: 1px solid rgba(255,255,255,0.2); padding-top: 6px; margin-top: 6px; }
    .carry-summary-row.total .value { color: var(--primary); font-size: 13px; }

    .schedule-table { width: 100%; border-collapse: collapse; font-size: 10px; }
    .schedule-table th { text-align: right; padding: 6px 8px; border-bottom: 2px solid var(--border); font-size: 9px; text-transform: uppercase; color: var(--text-muted); }
    .schedule-table th:first-child { text-align: left; }
    .schedule-table td { padding: 5px 8px; border-bottom: 1px solid var(--border); text-align: right; }
    .schedule-table td:first-child { text-align: left; }
    .schedule-table tr:last-child td { border-bottom: none; }
    .schedule-table .month-col { font-weight: 500; }
    .schedule-table .total-col { font-weight: 600; background: var(--bg); }
    .schedule-table tfoot td { font-weight: 600; border-top: 2px solid var(--border); background: var(--bg); }

    .carry-btn { padding: 4px 10px; font-size: 11px; border: 1px solid var(--border); background: var(--card); border-radius: 4px; cursor: pointer; color: var(--text-muted); }
    .carry-btn:hover { background: var(--bg); color: var(--text); }

    /* JV Modal */
    .jv-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .jv-modal.open { display: flex; }
    .jv-modal-content { background: #fff; border-radius: 12px; padding: 20px; width: 700px; max-height: 90vh; overflow: auto; }
    .jv-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .jv-modal-header h3 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .jv-modal-close { border: none; background: none; font-size: 24px; cursor: pointer; color: var(--text-muted); }
    .jv-modal-close:hover { color: var(--text); }

    .jv-section { margin-bottom: 16px; }
    .jv-section-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; letter-spacing: 0.5px; }
    .jv-inputs-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .jv-input-group { display: flex; flex-direction: column; gap: 3px; }
    .jv-input-group label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); }
    .jv-input-group .input-wrap { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; background: var(--card); }
    .jv-input-group .input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16,185,129,0.1); }
    .jv-input-group .input-wrap input { border: none; padding: 8px 10px; width: 100%; font-size: 13px; outline: none; }
    .jv-input-group .input-prefix, .jv-input-group .input-suffix { padding: 8px 10px; background: var(--bg); color: var(--text-muted); font-size: 12px; }
    .jv-input-group .input-prefix { border-right: 1px solid var(--border); }
    .jv-input-group .input-suffix { border-left: 1px solid var(--border); }
    .jv-input-group .readonly { background: var(--bg); color: var(--text); }

    .jv-results { background: var(--highlight); color: #fff; border-radius: 8px; padding: 14px; margin-bottom: 16px; }
    .jv-results-title { font-size: 11px; text-transform: uppercase; color: var(--text-light); margin-bottom: 10px; }
    .jv-results-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .jv-result-item { display: flex; justify-content: space-between; align-items: center; }
    .jv-result-item .label { font-size: 11px; color: var(--text-light); }
    .jv-result-item .value { font-size: 14px; font-weight: 600; }
    .jv-result-item .value.green { color: var(--primary); }
    .jv-result-item .value.highlight { color: #fff; font-size: 18px; }

    .jv-chart-container { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .jv-chart-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
    #jvChart { width: 100%; height: 180px; }

    .jv-scenario-section { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .jv-scenario-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .jv-scenario-row label { font-size: 11px; color: var(--text-muted); }
    .jv-scenario-row select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: var(--card); }
    .jv-compare-btn { padding: 6px 12px; background: var(--accent); color: #fff; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 500; }
    .jv-compare-btn:hover { background: var(--accent-dark); }
    .jv-scenario-legend { display: flex; gap: 16px; margin-top: 8px; font-size: 11px; }
    .jv-scenario-legend span { display: flex; align-items: center; gap: 4px; }
    .jv-scenario-legend .dot { width: 10px; height: 10px; border-radius: 50%; }
    .jv-scenario-legend .dot.primary { background: var(--accent); }
    .jv-scenario-legend .dot.secondary { background: #f59e0b; }

    /* DSCR Indicator Tooltip */
    .dscr-metric { position: relative; cursor: help; }
    .dscr-tooltip {
      display: none;
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--highlight);
      color: #fff;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 11px;
      min-width: 320px;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      margin-top: 8px;
    }
    .dscr-tooltip::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-bottom-color: var(--highlight);
    }
    .dscr-metric:hover .dscr-tooltip { display: block; }
    .dscr-tooltip-title { font-weight: 600; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 12px; }
    .dscr-tooltip-row { padding: 3px 0; color: var(--text-light); display: flex; justify-content: space-between; align-items: center; gap: 16px; white-space: nowrap; }
    .dscr-price-range { font-size: 10px; font-weight: 600; opacity: 0.85; text-align: right; font-variant-numeric: tabular-nums; }
    .dscr-tooltip-row.green { color: #10b981; }
    .dscr-tooltip-row.yellow { color: #eab308; }
    .dscr-tooltip-row.orange { color: #f97316; }
    .dscr-tooltip-row.red { color: #ef4444; }
    .dscr-tooltip-row.darkred { color: #dc2626; }
    .dscr-tooltip-row.active { background: rgba(255,255,255,0.15); border-radius: 4px; padding: 3px 6px; margin: 0 -6px; font-weight: 600; }
    .dscr-tooltip-current { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 10px; color: var(--text-light); }

    /* DSCR Status Colors */
    .dscr-status-green { color: #10b981 !important; }
    .dscr-status-yellow { color: #eab308 !important; }
    .dscr-status-orange { color: #f97316 !important; }
    .dscr-status-red { color: #ef4444 !important; }
    .dscr-status-darkred { color: #dc2626 !important; }

    /* Utility Breakdown */
    .expand-toggle { cursor: pointer; display: inline-block; width: 16px; font-size: 10px; color: var(--text-muted); transition: transform 0.2s; }
    .expand-toggle.open { transform: rotate(90deg); }
    .utility-detail td { padding-top: 4px !important; padding-bottom: 4px !important; background: var(--bg); font-size: 11px; }
    .utility-detail .input-wrap { background: #fff; }
    .utility-detail .expense-input { width: 80px; }

    /* Stress Test Table */
    .stress-test-container { overflow-x: auto; }
    .stress-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .stress-table th { text-align: left; padding: 8px 6px; border-bottom: 2px solid var(--border); font-size: 10px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
    .stress-table td { padding: 8px 6px; border-bottom: 1px solid var(--border); }
    .stress-table tr:last-child td { border-bottom: none; }
    .stress-table tr.base-case { background: var(--bg); font-weight: 600; }
    .stress-table .scenario-name { font-weight: 500; }
    .stress-table .status-pass { color: #10b981; font-weight: 600; }
    .stress-table .status-warn { color: #f59e0b; font-weight: 600; }
    .stress-table .status-fail { color: #ef4444; font-weight: 600; }
    .stress-table .value-negative { color: #ef4444; }
    .stress-table .value-positive { color: #10b981; }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--highlight);
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      z-index: 300;
      pointer-events: none;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast .toast-icon { color: var(--primary); }

    /* Settings Modal */
    .settings-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .settings-modal.open { display: flex; }
    .settings-modal-content { background: #fff; border-radius: 12px; padding: 20px; width: 450px; }
    .settings-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .settings-modal-header h3 { font-size: 16px; }
    .settings-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; margin-bottom: 12px; }
    .settings-input:focus { outline: none; border-color: var(--primary); }
    .settings-note { font-size: 11px; color: var(--text-muted); margin-bottom: 16px; }

    /* AI Chat Modal */
    .ai-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
    .ai-modal.open { display: flex; }
    .ai-modal-content { background: #fff; border-radius: 12px; width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
    .ai-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
    .ai-modal-header h3 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .ai-chat-messages { flex: 1; overflow-y: auto; padding: 16px 20px; min-height: 300px; max-height: 400px; }
    .ai-message { margin-bottom: 12px; }
    .ai-message.user { text-align: right; }
    .ai-message .bubble { display: inline-block; padding: 10px 14px; border-radius: 12px; max-width: 85%; text-align: left; font-size: 13px; line-height: 1.5; }
    .ai-message.user .bubble { background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
    .ai-message.assistant .bubble { background: var(--bg); color: var(--text); border-bottom-left-radius: 4px; }
    .ai-message.system .bubble { background: #fef3c7; color: #92400e; font-size: 11px; }
    .ai-chat-input { display: flex; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--border); }
    .ai-chat-input input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; }
    .ai-chat-input input:focus { outline: none; border-color: var(--primary); }
    .ai-chat-input button { padding: 10px 20px; background: #8b5cf6; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
    .ai-chat-input button:hover { background: #7c3aed; }
    .ai-chat-input button:disabled { background: #c4b5fd; cursor: not-allowed; }
    .ai-typing { color: var(--text-muted); font-style: italic; font-size: 12px; }
  </style>
</head>
<body>
  <header class="header">
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="logo">
        <div class="logo-icon">üè†</div>
        <span>PropCalc Pro</span>
      </div>
      <div class="vault-select" onclick="showVault()">
        <span>üì¶</span>
        <span>Vault</span>
        <span>‚ñæ</span>
      </div>
    </div>
    <div class="property-info">
      <input type="text" class="prop-name" id="propertyName" value="New Property Analysis" placeholder="Property Name" oninput="autoSave()" onchange="saveData()">
      <input type="text" class="prop-address" id="propertyAddress" value="" placeholder="123 Main St, City, State ZIP" oninput="autoSave()" onchange="saveData()">
    </div>
    <div class="header-actions">
      <button class="btn btn-new" onclick="newProperty()">+ New</button>
      <button class="btn btn-duplicate" onclick="duplicateProperty()">üìã Duplicate</button>
      <button class="btn btn-save" onclick="saveData()">üíæ Save</button>
      <button class="btn btn-pdf" onclick="exportToFile()">üì• Export</button>
      <button class="btn btn-pdf" onclick="document.getElementById('importFile').click()">üì§ Import</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importFromFile(event)">
      <button class="btn btn-pdf" onclick="window.print()">üìÑ PDF</button>
      <button class="btn btn-new" onclick="openAiChat()" style="background: #8b5cf6;">ü§ñ Ask AI</button>
      <button class="btn btn-pdf" onclick="openSettings()">‚öôÔ∏è</button>
      <button class="btn btn-delete" onclick="deleteProperty()">üóëÔ∏è</button>
    </div>
  </header>

  <main class="main">
    <!-- Left Column -->
    <div class="left-col">
      <!-- Mode Toggle -->
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setMode('traditional')">Traditional</button>
        <button class="mode-tab" onclick="setMode('dscr')">Cash-Carry-Refi-DSCR</button>
      </div>

      <!-- Acquisition Details -->
      <div class="card">
        <div class="card-header">
          <span>üí∞ Acquisition Details</span>
          <span class="badge">‚öôÔ∏è SETUP</span>
        </div>
        <div class="input-row cols-2">
          <div class="input-group">
            <label>Purchase Price</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="purchasePrice" value="" oninput="calculate()" placeholder="0">
            </div>
          </div>
          <div class="input-group">
            <label>Exit ARV</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="exitArv" value="" placeholder="0" oninput="calculate()">
            </div>
          </div>
        </div>
        <!-- Traditional-only: Down % row -->
        <div class="input-row cols-3 trad-only">
          <div class="input-group">
            <label>Down %</label>
            <div class="input-wrap">
              <input type="number" id="downPercent" value="" placeholder="25" oninput="calculate()">
            </div>
          </div>
          <div class="input-group">
            <label>Closing Cost</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="closingCost" value="" placeholder="0" oninput="calculate()">
            </div>
          </div>
          <div class="input-group">
            <label>Upfront Rehab</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="rehabCost" value="0" oninput="calculate()">
            </div>
          </div>
        </div>
        <!-- DSCR-only: Carry costs and LTV row -->
        <div class="input-row cols-3 dscr-only">
          <div class="input-group">
            <label>Closing Cost</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="closingCostDscr" value="" placeholder="0" oninput="calculate()">
            </div>
          </div>
          <div class="input-group">
            <label>Upfront Rehab</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="rehabCostDscr" value="0" oninput="calculate()">
            </div>
          </div>
          <div class="input-group">
            <label>DSCR LTV %</label>
            <div class="input-wrap">
              <input type="number" id="dscrLtv" value="" placeholder="75" oninput="calculate()">
            </div>
          </div>
        </div>
        <div class="input-row cols-2">
          <div class="input-group">
            <label>Interest Rate %</label>
            <div class="input-wrap">
              <input type="number" id="interestRate" value="" placeholder="7" step="0.125" oninput="calculate()">
            </div>
          </div>
          <div class="input-group">
            <label>Loan Term (Years)</label>
            <div class="input-wrap">
              <input type="number" id="loanTerm" value="30" oninput="calculate()">
            </div>
          </div>
        </div>
        <!-- DSCR-only: Carry period and rate -->
        <div class="input-row cols-2 dscr-only">
          <div class="input-group">
            <label>Carry Period (Months)</label>
            <div class="input-wrap">
              <input type="number" id="carryMonths" value="" placeholder="6" oninput="calculate()">
            </div>
          </div>
          <div class="input-group">
            <label>Default Carry Rate %</label>
            <div class="input-wrap">
              <input type="number" id="carryRate" value="" placeholder="8" step="0.5" oninput="calculate()">
            </div>
          </div>
        </div>
        <div class="dscr-only" style="margin-bottom: 10px;">
          <button class="carry-btn" onclick="openCarryModal()">‚öôÔ∏è Mixed Carry Rates...</button>
          <span id="carryTranchesSummary" style="margin-left: 8px; font-size: 11px; color: var(--text-muted);"></span>
        </div>
        <div class="dscr-only" style="margin-bottom: 10px; display: flex; align-items: center; gap: 12px;">
          <div class="input-group" style="flex: 0 0 auto;">
            <label>JV Split (Your %)</label>
            <div class="input-wrap" style="width: 100px;">
              <input type="number" id="jvSplitMain" value="100" min="0" max="100" oninput="calculate()">
              <span class="input-prefix">%</span>
            </div>
          </div>
          <button class="carry-btn" onclick="openJvModal()" style="margin-top: 14px;">üìä JV Capital Recovery...</button>
        </div>
        <!-- Traditional highlight box -->
        <div class="highlight-box trad-only">
          <div class="label">Total Out of Pocket</div>
          <div class="value" id="totalOutOfPocket">$98,000</div>
          <div class="breakdown">
            <span>DOWN: <strong id="downAmount">$90,000</strong></span>
            <span>FEES: <strong id="feesAmount">$8,000</strong></span>
            <span>REHAB: <strong id="rehabAmount">$0</strong></span>
          </div>
        </div>
        <!-- DSCR highlight box -->
        <div class="highlight-box dscr-only">
          <div class="label" id="dscrHighlightLabel">Cash Left in Deal</div>
          <div class="value" id="dscrCashLeft">$60,220</div>
          <div class="breakdown-row">
            <span>PURCHASE: <strong id="dscrPurchase">$360,000</strong></span>
            <span>FEES: <strong id="dscrFees">$8,000</strong></span>
            <span>REHAB: <strong id="dscrRehab">$0</strong></span>
            <span>CARRY: <strong id="dscrCarry">$14,720</strong></span>
          </div>
          <div class="loan-info">
            LOAN: <strong id="dscrLoanAmount">$322,500</strong> (<span id="dscrLtvDisplay">75%</span> of <span id="dscrArvDisplay">$430k</span> ARV)
          </div>
        </div>
      </div>

      <!-- Revenue & Occupancy -->
      <div class="card">
        <div class="card-header">
          <span>üìà Revenue & Occupancy</span>
          <span class="badge">INCOME PROFILE</span>
        </div>
        <div class="units-grid">
          <div class="unit-box">
            <div class="unit-title">Unit 1 Income</div>
            <div class="input-group">
              <label>Monthly Rent</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit1Rent" value="" placeholder="0" oninput="calculate()">
              </div>
            </div>
            <div class="input-group">
              <label>Misc (Parking/Pet)</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit1Misc" value="0" oninput="calculate()">
              </div>
            </div>
          </div>
          <div class="unit-box">
            <div class="unit-title">Unit 2 Income</div>
            <div class="input-group">
              <label>Monthly Rent</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit2Rent" value="" placeholder="0" oninput="calculate()">
              </div>
            </div>
            <div class="input-group">
              <label>Misc (Parking/Pet)</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit2Misc" value="0" oninput="calculate()">
              </div>
            </div>
          </div>
          <div class="unit-box">
            <div class="unit-title">Unit 3 Income</div>
            <div class="input-group">
              <label>Monthly Rent</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit3Rent" value="0" oninput="calculate()">
              </div>
            </div>
            <div class="input-group">
              <label>Misc (Parking/Pet)</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit3Misc" value="0" oninput="calculate()">
              </div>
            </div>
          </div>
          <div class="unit-box">
            <div class="unit-title">Unit 4 Income</div>
            <div class="input-group">
              <label>Monthly Rent</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit4Rent" value="0" oninput="calculate()">
              </div>
            </div>
            <div class="input-group">
              <label>Misc (Parking/Pet)</label>
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" id="unit4Misc" value="0" oninput="calculate()">
              </div>
            </div>
          </div>
        </div>
        <div class="bottom-row">
          <div class="revenue-box">
            <div class="label">Total Monthly Revenue</div>
            <div class="value" id="totalMonthlyRevenue">$5,600</div>
          </div>
          <div class="input-group">
            <label>Vacancy Rate (%)</label>
            <div class="input-wrap" style="width: 80px;">
              <input type="number" id="vacancyRate" value="" placeholder="0" oninput="calculate()">
            </div>
          </div>
        </div>
      </div>

      <!-- Operating Expenses -->
      <div class="card">
        <div class="card-header">
          <span>üîß Operating Expenses</span>
          <span class="badge">LOGIC ENGINE</span>
        </div>
        <table class="expenses-table">
          <thead>
            <tr>
              <th>Expense</th>
              <th>Basis</th>
              <th>Freq</th>
              <th style="text-align:right">Yearly</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="expense-name">Property Taxes</td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">$</span>
                  <input type="number" id="propTaxes" value="" placeholder="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn" data-field="propTaxes" data-mode="pct">%</button>
                  <button class="toggle-btn active" data-field="propTaxes" data-mode="dollar">$</button>
                </div>
                <div class="toggle-group" style="margin-left:4px">
                  <button class="toggle-btn" data-field="propTaxes" data-freq="mo">MO</button>
                  <button class="toggle-btn active" data-field="propTaxes" data-freq="yr">YR</button>
                </div>
              </td>
              <td class="expense-yearly" id="propTaxesYearly">$7,922</td>
            </tr>
            <tr>
              <td class="expense-name">Insurance</td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">$</span>
                  <input type="number" id="insurance" value="" placeholder="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn" data-field="insurance" data-mode="pct">%</button>
                  <button class="toggle-btn active" data-field="insurance" data-mode="dollar">$</button>
                </div>
                <div class="toggle-group" style="margin-left:4px">
                  <button class="toggle-btn" data-field="insurance" data-freq="mo">MO</button>
                  <button class="toggle-btn active" data-field="insurance" data-freq="yr">YR</button>
                </div>
              </td>
              <td class="expense-yearly" id="insuranceYearly">$3,500</td>
            </tr>
            <tr>
              <td class="expense-name">Maintenance</td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">%</span>
                  <input type="number" id="maintenance" value="" placeholder="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn active" data-field="maintenance" data-mode="pct">%</button>
                  <button class="toggle-btn" data-field="maintenance" data-mode="dollar">$</button>
                </div>
                <span style="margin-left:4px;font-size:10px;color:var(--text-muted)">GROSS %</span>
              </td>
              <td class="expense-yearly" id="maintenanceYearly">$5,376</td>
            </tr>
            <tr>
              <td class="expense-name">
                <span class="expand-toggle" onclick="toggleUtilityBreakdown()">‚ñ∂</span>
                Utilities
              </td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">$</span>
                  <input type="number" id="utilities" value="" placeholder="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn" data-field="utilities" data-mode="pct">%</button>
                  <button class="toggle-btn active" data-field="utilities" data-mode="dollar">$</button>
                </div>
                <div class="toggle-group" style="margin-left:4px">
                  <button class="toggle-btn active" data-field="utilities" data-freq="mo">MO</button>
                  <button class="toggle-btn" data-field="utilities" data-freq="yr">YR</button>
                </div>
              </td>
              <td class="expense-yearly" id="utilitiesYearly">$1,800</td>
            </tr>
            <tr class="utility-detail" style="display:none;">
              <td style="padding-left: 24px; color: var(--text-muted);">‚Ü≥ Electric</td>
              <td><div class="input-wrap expense-input"><span class="input-prefix">$</span><input type="number" id="utilElectric" value="0" oninput="sumUtilities()"></div></td>
              <td><span style="font-size:10px;color:var(--text-muted);">/MO</span></td>
              <td class="expense-yearly" id="utilElectricYearly">$0</td>
            </tr>
            <tr class="utility-detail" style="display:none;">
              <td style="padding-left: 24px; color: var(--text-muted);">‚Ü≥ Gas/Heat</td>
              <td><div class="input-wrap expense-input"><span class="input-prefix">$</span><input type="number" id="utilGas" value="0" oninput="sumUtilities()"></div></td>
              <td><span style="font-size:10px;color:var(--text-muted);">/MO</span></td>
              <td class="expense-yearly" id="utilGasYearly">$0</td>
            </tr>
            <tr class="utility-detail" style="display:none;">
              <td style="padding-left: 24px; color: var(--text-muted);">‚Ü≥ Water/Sewer</td>
              <td><div class="input-wrap expense-input"><span class="input-prefix">$</span><input type="number" id="utilWater" value="0" oninput="sumUtilities()"></div></td>
              <td><span style="font-size:10px;color:var(--text-muted);">/MO</span></td>
              <td class="expense-yearly" id="utilWaterYearly">$0</td>
            </tr>
            <tr class="utility-detail" style="display:none;">
              <td style="padding-left: 24px; color: var(--text-muted);">‚Ü≥ Trash</td>
              <td><div class="input-wrap expense-input"><span class="input-prefix">$</span><input type="number" id="utilTrash" value="0" oninput="sumUtilities()"></div></td>
              <td><span style="font-size:10px;color:var(--text-muted);">/MO</span></td>
              <td class="expense-yearly" id="utilTrashYearly">$0</td>
            </tr>
            <tr class="utility-detail" style="display:none;">
              <td style="padding-left: 24px; color: var(--text-muted);">‚Ü≥ Lawn/Snow</td>
              <td><div class="input-wrap expense-input"><span class="input-prefix">$</span><input type="number" id="utilLawn" value="0" oninput="sumUtilities()"></div></td>
              <td><span style="font-size:10px;color:var(--text-muted);">/MO</span></td>
              <td class="expense-yearly" id="utilLawnYearly">$0</td>
            </tr>
            <tr class="utility-detail" style="display:none;">
              <td style="padding-left: 24px; color: var(--text-muted);">‚Ü≥ Other</td>
              <td><div class="input-wrap expense-input"><span class="input-prefix">$</span><input type="number" id="utilOther" value="0" oninput="sumUtilities()"></div></td>
              <td><span style="font-size:10px;color:var(--text-muted);">/MO</span></td>
              <td class="expense-yearly" id="utilOtherYearly">$0</td>
            </tr>
            <tr>
              <td class="expense-name">Property Mgmt</td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">%</span>
                  <input type="number" id="propMgmt" value="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn active" data-field="propMgmt" data-mode="pct">%</button>
                  <button class="toggle-btn" data-field="propMgmt" data-mode="dollar">$</button>
                </div>
                <span style="margin-left:4px;font-size:10px;color:var(--text-muted)">GROSS %</span>
              </td>
              <td class="expense-yearly" id="propMgmtYearly">$0</td>
            </tr>
            <tr>
              <td class="expense-name">Capex Reserve</td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">%</span>
                  <input type="number" id="capex" value="" placeholder="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn active" data-field="capex" data-mode="pct">%</button>
                  <button class="toggle-btn" data-field="capex" data-mode="dollar">$</button>
                </div>
                <span style="margin-left:4px;font-size:10px;color:var(--text-muted)">GROSS %</span>
              </td>
              <td class="expense-yearly" id="capexYearly">$5,376</td>
            </tr>
            <tr>
              <td class="expense-name">Mortgage Insurance</td>
              <td>
                <div class="input-wrap expense-input">
                  <span class="input-prefix">$</span>
                  <input type="number" id="mortgageIns" value="0" oninput="calculate()">
                </div>
              </td>
              <td>
                <div class="toggle-group">
                  <button class="toggle-btn" data-field="mortgageIns" data-mode="pct">%</button>
                  <button class="toggle-btn active" data-field="mortgageIns" data-mode="dollar">$</button>
                </div>
                <div class="toggle-group" style="margin-left:4px">
                  <button class="toggle-btn active" data-field="mortgageIns" data-freq="mo">MO</button>
                  <button class="toggle-btn" data-field="mortgageIns" data-freq="yr">YR</button>
                </div>
              </td>
              <td class="expense-yearly" id="mortgageInsYearly">$0</td>
            </tr>
          </tbody>
        </table>
        <div class="expense-total">
          <span class="label">Net Operating Expenses</span>
          <span class="value" id="totalExpenses">$23,974</span>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="right-col">
      <!-- Growth Assumptions -->
      <div class="card" style="padding:10px 14px;">
        <div class="card-header" style="margin-bottom:8px;">
          <span>üìà Growth Assumptions</span>
          <span class="badge">ANNUAL %</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
          <div class="input-group">
            <label>Appreciation</label>
            <div class="input-wrap">
              <input type="number" id="appreciationRate" value="" placeholder="3" step="0.5" oninput="calculate()">
              <span class="input-prefix">%</span>
            </div>
          </div>
          <div class="input-group">
            <label>Rent Growth</label>
            <div class="input-wrap">
              <input type="number" id="rentGrowth" value="" placeholder="2" step="0.5" oninput="calculate()">
              <span class="input-prefix">%</span>
            </div>
          </div>
          <div class="input-group">
            <label>Cost Increase</label>
            <div class="input-wrap">
              <input type="number" id="costIncrease" value="" placeholder="2" step="0.5" oninput="calculate()">
              <span class="input-prefix">%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Metrics Bar -->
      <div class="metrics-bar">
        <div class="metric dscr-metric" id="dscrMetric">
          <div class="label">DSCR <span id="dscrIndicator">üü¢</span></div>
          <div class="value" id="dscr">1.80</div>
          <div class="sub" id="dscrStatus">Strong</div>
          <div class="dscr-tooltip" id="dscrTooltip">
            <div class="dscr-tooltip-title">DSCR Lender Guidelines</div>
            <div class="dscr-tooltip-row green">
              <span class="dscr-tier-label">üü¢ 1.25+</span>
              <span class="dscr-price-range"></span>
            </div>
            <div class="dscr-tooltip-row yellow">
              <span class="dscr-tier-label">üü° 1.15 ‚Äì 1.24</span>
              <span class="dscr-price-range"></span>
            </div>
            <div class="dscr-tooltip-row orange">
              <span class="dscr-tier-label">üü† 1.05 ‚Äì 1.14</span>
              <span class="dscr-price-range"></span>
            </div>
            <div class="dscr-tooltip-row red">
              <span class="dscr-tier-label">üî¥ 1.00 ‚Äì 1.04</span>
              <span class="dscr-price-range"></span>
            </div>
            <div class="dscr-tooltip-row darkred">
              <span class="dscr-tier-label">‚ùå &lt; 1.00</span>
              <span class="dscr-price-range"></span>
            </div>
            <div class="dscr-tooltip-current" id="dscrTooltipCurrent"></div>
          </div>
        </div>
        <div class="metric">
          <div class="label">Cap Rate</div>
          <div class="value" id="capRate">10.51%</div>
          <div class="sub">Unleveraged</div>
        </div>
        <div class="metric">
          <div class="label">Monthly Flow</div>
          <div class="value" id="monthlyFlow">$1,403</div>
          <div class="sub">After Debt</div>
        </div>
        <div class="metric highlight">
          <div class="label">Cash-on-Cash</div>
          <div class="value" id="cashOnCash">17.18%</div>
          <div class="sub">Pre-Tax ROI</div>
        </div>
      </div>

      <!-- Growth & Exit Milestones -->
      <div class="card">
        <div class="card-header">
          <span>‚è±Ô∏è Growth & Exit Milestones</span>
          <div style="display:flex;gap:12px;font-size:10px;">
            <span>‚óè EQUITY BASIS</span>
            <span style="color:var(--primary)">‚óè NET PROFIT</span>
          </div>
        </div>
        <div class="milestones">
          <div class="milestone">
            <div class="milestone-header">
              <span>üìÖ</span>
              <span>YEAR 5 MILESTONE</span>
            </div>
            <div class="milestone-row">
              <span class="label">Est. Equity</span>
              <span class="value" id="equity5">$245,023</span>
            </div>
            <div class="milestone-row">
              <span class="label">Debt Remaining</span>
              <span class="value red" id="debt5">$252,000</span>
            </div>
            <div class="milestone-row">
              <span class="label">Total Flow</span>
              <span class="value green" id="flow5">+$90,646</span>
            </div>
            <div class="net-gain">
              <div class="label">Total Net Gain</div>
              <div class="value" id="netGain5">$237,670</div>
            </div>
          </div>
          <div class="milestone">
            <div class="milestone-header">
              <span>üìÖ</span>
              <span>YEAR 10 MILESTONE</span>
            </div>
            <div class="milestone-row">
              <span class="label">Est. Equity</span>
              <span class="value" id="equity10">$347,571</span>
            </div>
            <div class="milestone-row">
              <span class="label">Debt Remaining</span>
              <span class="value red" id="debt10">$230,000</span>
            </div>
            <div class="milestone-row">
              <span class="label">Total Flow</span>
              <span class="value green" id="flow10">+$198,220</span>
            </div>
            <div class="net-gain">
              <div class="label">Total Net Gain</div>
              <div class="value" id="netGain10">$447,791</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="card">
        <div class="card-header">
          <span>üìä Asset/Debt Forecaster</span>
          <div class="chart-legend">
            <span><span class="dot asset"></span> ASSET</span>
            <span><span class="dot loan"></span> LOAN</span>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="chart"></canvas>
          <div id="chartTooltip" class="chart-tooltip"></div>
        </div>
      </div>

      <!-- Stress Test -->
      <div class="card">
        <div class="card-header">
          <span>üî• Stress Test</span>
          <span class="badge">SENSITIVITY</span>
        </div>
        <div class="stress-test-container">
          <table class="stress-table">
            <thead>
              <tr>
                <th>Scenario</th>
                <th>DSCR</th>
                <th>Monthly CF</th>
                <th>CoC</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="stressTestBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Vault Modal -->
  <div id="vaultModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;border-radius:12px;padding:20px;width:400px;max-height:80vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="font-size:16px;">üì¶ Property Vault</h3>
        <button onclick="hideVault()" style="border:none;background:none;font-size:20px;cursor:pointer;">√ó</button>
      </div>
      <div id="vaultList"></div>
    </div>
  </div>

  <!-- Carry Details Modal -->
  <div id="carryModal" class="carry-modal">
    <div class="carry-modal-content">
      <div class="carry-modal-header">
        <h3>üí∞ Mixed Carry Details</h3>
        <button class="carry-modal-close" onclick="closeCarryModal()">√ó</button>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Left Column: Tranche Configuration -->
        <div>
          <div class="tranche-row header">
            <span>Name</span>
            <span>Amount</span>
            <span>Rate %</span>
            <span>Points</span>
            <span></span>
            <span></span>
          </div>
          <div id="trancheList" class="tranche-list"></div>
          <button id="addTrancheBtn" class="add-tranche-btn" onclick="addTranche()">+ Add Tranche</button>

          <div id="remainderInfo" class="tranche-remainder"></div>

          <div id="carrySummary" class="carry-summary" style="margin-top: 10px;"></div>

          <div style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <label style="font-size: 10px; text-transform: uppercase; color: var(--text-muted); white-space: nowrap;">Rent During Carry</label>
              <div class="input-wrap" style="width: 80px;">
                <input type="number" id="carryRentPercent" value="0" min="0" max="100" oninput="updateCarrySchedule()" style="padding: 4px 6px; font-size: 12px;">
                <span class="input-prefix" style="font-size: 11px;">%</span>
              </div>
            </div>
            <div id="carryPeriodAnalysis" style="font-size: 10px;"></div>
          </div>
        </div>

        <!-- Right Column: Payment Schedule -->
        <div>
          <h4 style="font-size: 10px; margin-bottom: 6px; color: var(--text-muted); text-transform: uppercase;">Monthly Payment Schedule (Interest Only)</h4>
          <div style="border: 1px solid var(--border); border-radius: 6px;">
            <table class="schedule-table">
              <thead>
                <tr id="scheduleHeader"></tr>
              </thead>
              <tbody id="scheduleBody"></tbody>
              <tfoot id="scheduleFoot"></tfoot>
            </table>
          </div>
        </div>
      </div>

      <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-pdf" onclick="clearTranches()">Clear All</button>
        <button class="btn btn-save" onclick="closeCarryModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- JV Capital Recovery Modal -->
  <div id="jvModal" class="jv-modal">
    <div class="jv-modal-content">
      <div class="jv-modal-header">
        <h3>üìä JV Capital Recovery Analysis</h3>
        <button class="jv-modal-close" onclick="closeJvModal()">√ó</button>
      </div>

      <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;">
        Analyze partnership deals where investor capital is repaid first, then cash flow splits by percentage.
      </p>

      <div class="jv-section">
        <div class="jv-section-title">Your Investment</div>
        <div class="jv-inputs-row" style="grid-template-columns: 1fr 1fr;">
          <div class="jv-input-group">
            <label>Cash In Deal</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="jvCashIn" class="readonly" readonly>
            </div>
          </div>
          <div class="jv-input-group">
            <label>Your Split (after protection)</label>
            <div class="input-wrap">
              <input type="number" id="jvSplitYou" value="50" min="0" max="100" oninput="updateJvResults()">
              <span class="input-suffix">%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="jv-section">
        <div class="jv-section-title">Timeline Controls</div>
        <div class="jv-inputs-row" style="grid-template-columns: 1fr 1fr 1fr;">
          <div class="jv-input-group">
            <label>Refi Happens At</label>
            <div class="input-wrap">
              <span class="input-prefix">Mo</span>
              <input type="number" id="jvRefiMonth" value="4" min="1" max="24" oninput="updateJvResults()">
            </div>
            <span style="font-size: 9px; color: var(--text-muted);">CF changes from pre‚Üípost</span>
          </div>
          <div class="jv-input-group">
            <label>100% to You Until</label>
            <div class="input-wrap">
              <span class="input-prefix">Mo</span>
              <input type="number" id="jvPaybackMonths" value="6" min="1" max="60" oninput="updateJvResults()">
            </div>
            <span style="font-size: 9px; color: var(--text-muted);">Then switches to split</span>
          </div>
          <div class="jv-input-group">
            <label>Project Out To</label>
            <div class="input-wrap">
              <input type="number" id="jvMonthsToProject" value="60" min="12" max="120" oninput="updateJvResults()">
              <span class="input-suffix">mo</span>
            </div>
          </div>
        </div>
      </div>

      <div class="jv-section">
        <div class="jv-section-title">Cash Flow Amounts (from DSCR calc)</div>
        <div class="jv-inputs-row" style="grid-template-columns: 1fr 1fr;">
          <div class="jv-input-group">
            <label>Pre-Refi CF</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="jvPreRefiCF" class="readonly" readonly>
              <span class="input-suffix">/mo</span>
            </div>
          </div>
          <div class="jv-input-group">
            <label>Post-Refi CF</label>
            <div class="input-wrap">
              <span class="input-prefix">$</span>
              <input type="number" id="jvPostRefiCF" class="readonly" readonly>
              <span class="input-suffix">/mo</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase Breakdown -->
      <div class="jv-section" style="background: var(--bg); border-radius: 8px; padding: 12px;">
        <div class="jv-section-title">Phase Breakdown</div>
        <div id="jvPhaseBreakdown" style="font-size: 12px; line-height: 1.8;"></div>
      </div>

      <div id="jvResults" class="jv-results">
        <div class="jv-results-title">Results</div>
        <div class="jv-results-grid">
          <div class="jv-result-item">
            <span class="label">Cash Returned (Payback Period):</span>
            <span class="value" id="jvCashReturned">$0</span>
          </div>
          <div class="jv-result-item">
            <span class="label">Capital Remaining:</span>
            <span class="value" id="jvCapitalRemaining">$0</span>
          </div>
          <div class="jv-result-item">
            <span class="label">Stabilized Monthly (You):</span>
            <span class="value green" id="jvStabilizedMonthly">$0</span>
          </div>
          <div class="jv-result-item">
            <span class="label">Stabilized CoC:</span>
            <span class="value green" id="jvStabilizedCoC">0%</span>
          </div>
          <div class="jv-result-item">
            <span class="label">Full Payback Month:</span>
            <span class="value highlight" id="jvFullPaybackMonth">--</span>
          </div>
          <div class="jv-result-item">
            <span class="label">Total to You (60 mo):</span>
            <span class="value green" id="jvTotalToYou">$0</span>
          </div>
        </div>
      </div>

      <div class="jv-chart-container">
        <div class="jv-chart-title">Remaining Capital Over Time</div>
        <canvas id="jvChart"></canvas>
      </div>

      <div class="jv-scenario-section">
        <div class="jv-section-title">Scenario Comparison</div>
        <div class="jv-scenario-row">
          <label>Compare: Refi at month</label>
          <select id="jvCompareMonth1">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="12">12</option>
          </select>
          <span>vs</span>
          <select id="jvCompareMonth2">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6" selected>6</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="12">12</option>
          </select>
          <button class="jv-compare-btn" onclick="compareJvScenarios()">Compare</button>
        </div>
        <div id="jvScenarioLegend" class="jv-scenario-legend" style="display: none;">
          <span><span class="dot primary"></span> <span id="jvLegend1">Refi @ 4</span></span>
          <span><span class="dot secondary"></span> <span id="jvLegend2">Refi @ 6</span></span>
        </div>
      </div>

      <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
        <button class="btn btn-pdf" onclick="resetJvDefaults()">Reset</button>
        <button class="btn btn-save" onclick="closeJvModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="settings-modal">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <h3>‚öôÔ∏è Settings</h3>
        <button onclick="closeSettings()" style="border:none;background:none;font-size:20px;cursor:pointer;">√ó</button>
      </div>
      <div>
        <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">OpenAI API Key</label>
        <input type="password" id="openaiKey" class="settings-input" placeholder="sk-..." value="">
        <p class="settings-note">Your API key is stored locally in your browser and never sent anywhere except OpenAI. Get your key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></p>

        <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">Model</label>
        <select id="openaiModel" class="settings-input">
          <option value="gpt-4o-mini">GPT-4o Mini (Fast & Cheap)</option>
          <option value="gpt-4o">GPT-4o (Smarter)</option>
          <option value="gpt-4-turbo">GPT-4 Turbo</option>
        </select>
      </div>
      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;">
        <button class="btn btn-save" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- AI Chat Modal -->
  <div id="aiModal" class="ai-modal">
    <div class="ai-modal-content">
      <div class="ai-modal-header">
        <h3>ü§ñ AI Deal Advisor</h3>
        <button onclick="closeAiChat()" style="border:none;background:none;font-size:20px;cursor:pointer;">√ó</button>
      </div>
      <div id="aiMessages" class="ai-chat-messages">
        <div class="ai-message system">
          <div class="bubble">I have access to your current deal numbers. Ask me anything about the analysis, risks, or how to improve the deal.</div>
        </div>
      </div>
      <div class="ai-chat-input">
        <input type="text" id="aiInput" placeholder="Ask about this deal..." onkeypress="if(event.key==='Enter')sendAiMessage()">
        <button onclick="sendAiMessage()" id="aiSendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <span class="toast-icon">‚úì</span>
    <span id="toastMessage">Auto-saved</span>
  </div>

  <footer class="footer">
    <div class="footer-logo">
      <span>üè†</span>
      <span>PROPCALC PRO V1.0</span>
    </div>
    <div class="footer-features">
      <span><span class="check">‚úì</span> MULTI-UNIT LOGIC</span>
      <span><span class="check">‚úì</span> MISC INCOME SUPPORT</span>
      <span><span class="check">‚úì</span> DSCR VALIDATOR</span>
    </div>
    <p style="margin-top:8px;">PropCalc Pro is a computational simulation tool for real estate valuation.</p>
    <p style="margin-top:8px; font-size: 10px;">Author: Thomas Daly ‚Äî tom.m.daly@gmail.com</p>
  </footer>

  <script>
    // State
    let currentPropertyId = null;
    let currentMode = 'traditional'; // 'traditional' or 'dscr'
    let carryTranches = []; // Array of { name, amount, rate }

    // JV Capital Recovery configuration
    let jvConfig = {
      splitYou: 50,        // Percentage
      paybackMonths: 6,
      refiMonth: 4,
      monthsToProject: 60
    };

    // JV simulation results (computed, not stored)
    let jvResults = {
      months: [],
      dealCF: [],
      cashToYou: [],
      cashToOperator: [],
      remainingCapital: [],
      cumCashToYou: [],
      cumCashToOperator: []
    };

    const expenseConfig = {
      propTaxes: { mode: 'dollar', freq: 'yr' },
      insurance: { mode: 'dollar', freq: 'yr' },
      maintenance: { mode: 'pct', freq: 'yr' },
      utilities: { mode: 'dollar', freq: 'mo' },
      propMgmt: { mode: 'pct', freq: 'yr' },
      capex: { mode: 'pct', freq: 'yr' },
      mortgageIns: { mode: 'dollar', freq: 'mo' }
    };

    // Toggle button handlers
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const field = this.dataset.field;
        const mode = this.dataset.mode;
        const freq = this.dataset.freq;

        // Find sibling buttons in same group
        const group = this.parentElement;
        group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        if (mode) expenseConfig[field].mode = mode;
        if (freq) expenseConfig[field].freq = freq;

        // Update prefix
        const input = document.getElementById(field);
        const prefix = input.parentElement.querySelector('.input-prefix');
        if (mode) prefix.textContent = mode === 'pct' ? '%' : '$';

        calculate();
      });
    });

    // Mode switching
    function setMode(mode) {
      currentMode = mode;

      // Update body class for CSS visibility
      if (mode === 'dscr') {
        document.body.classList.add('dscr-mode');
      } else {
        document.body.classList.remove('dscr-mode');
      }

      // Update tab buttons
      document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.classList.remove('active');
        if ((mode === 'traditional' && tab.textContent === 'Traditional') ||
            (mode === 'dscr' && tab.textContent.includes('DSCR'))) {
          tab.classList.add('active');
        }
      });

      calculate();
    }

    // Carry Modal Functions
    function openCarryModal() {
      document.getElementById('carryModal').classList.add('open');
      renderTranches();
      updateCarrySchedule();
    }

    function closeCarryModal() {
      document.getElementById('carryModal').classList.remove('open');
      calculate(); // Recalculate with new tranches
      saveData(); // Auto-save when closing modal
    }

    function addTranche() {
      if (carryTranches.length >= 5) return;
      const names = ['Seller Financing', 'Family/Friends', 'Hard Money', 'Private Lender', 'Bridge Loan'];
      const defaultName = names[carryTranches.length] || `Tranche ${carryTranches.length + 1}`;
      // Calculate remaining amount
      const totalCarry = getTotalCarryAmount();
      const usedAmount = carryTranches.reduce((sum, t) => sum + t.amount, 0);
      const remainingAmount = Math.max(0, totalCarry - usedAmount);
      carryTranches.push({ name: defaultName, amount: remainingAmount, rate: 0, points: 0 });
      renderTranches();
      updateCarrySchedule();
    }

    function getTotalCarryAmount() {
      const purchasePrice = getVal('purchasePrice');
      const closingCost = getVal('closingCostDscr');
      const rehabCost = getVal('rehabCostDscr');
      return purchasePrice + closingCost + rehabCost;
    }

    function maxOutTranche(index) {
      const totalCarry = getTotalCarryAmount();
      const usedByOthers = carryTranches.reduce((sum, t, i) => i === index ? sum : sum + t.amount, 0);
      const remaining = Math.max(0, totalCarry - usedByOthers);
      carryTranches[index].amount = remaining;
      renderTranches();
      updateCarrySchedule();
    }

    function removeTranche(index) {
      carryTranches.splice(index, 1);
      renderTranches();
      updateCarrySchedule();
    }

    function updateTranche(index, field, value) {
      if (field === 'amount' || field === 'rate' || field === 'points') {
        carryTranches[index][field] = parseFloat(value) || 0;
      } else {
        carryTranches[index][field] = value;
      }
      updateCarrySchedule();
    }

    function clearTranches() {
      carryTranches = [];
      renderTranches();
      updateCarrySchedule();
    }

    function renderTranches() {
      const list = document.getElementById('trancheList');
      const addBtn = document.getElementById('addTrancheBtn');

      if (carryTranches.length === 0) {
        list.innerHTML = '<p style="font-size: 11px; color: var(--text-muted); text-align: center; padding: 12px;">No tranches configured. All carry uses the default rate.</p>';
      } else {
        list.innerHTML = carryTranches.map((t, i) => `
          <div class="tranche-row">
            <div class="input-group">
              <div class="input-wrap">
                <input type="text" value="${t.name}" onchange="updateTranche(${i}, 'name', this.value)" style="font-size: 12px;">
              </div>
            </div>
            <div class="input-group">
              <div class="input-wrap">
                <span class="input-prefix">$</span>
                <input type="number" value="${t.amount}" onchange="updateTranche(${i}, 'amount', this.value)">
              </div>
            </div>
            <div class="input-group">
              <div class="input-wrap">
                <input type="number" value="${t.rate}" step="0.1" onchange="updateTranche(${i}, 'rate', this.value)">
                <span class="input-prefix">%</span>
              </div>
            </div>
            <div class="input-group">
              <div class="input-wrap">
                <input type="number" value="${t.points || 0}" step="0.5" onchange="updateTranche(${i}, 'points', this.value)">
                <span class="input-prefix">pts</span>
              </div>
            </div>
            <button class="max-btn" onclick="maxOutTranche(${i})" title="Max out this tranche">‚§¢</button>
            <button class="remove-btn" onclick="removeTranche(${i})">√ó</button>
          </div>
        `).join('');
      }

      addBtn.disabled = carryTranches.length >= 5;
    }

    function updateCarrySchedule() {
      const purchasePrice = getVal('purchasePrice');
      const closingCost = getVal('closingCostDscr');
      const rehabCost = getVal('rehabCostDscr');
      const carryMonths = getVal('carryMonths');
      const defaultRate = getVal('carryRate');

      const totalCashNeeded = purchasePrice + closingCost + rehabCost;

      // Calculate how much each tranche covers
      let remaining = totalCashNeeded;
      const trancheAllocations = carryTranches.map(t => {
        const allocated = Math.min(t.amount, remaining);
        remaining -= allocated;
        return { ...t, allocated };
      });

      // Remaining goes to default rate
      const defaultAllocation = remaining;

      // Update remainder info
      const remainderEl = document.getElementById('remainderInfo');
      if (defaultAllocation > 0) {
        remainderEl.innerHTML = `<strong>Remainder:</strong> $${defaultAllocation.toLocaleString()} at ${defaultRate}% (default rate)`;
        remainderEl.style.display = 'block';
      } else {
        remainderEl.style.display = 'none';
      }

      // Calculate monthly interest for each tranche
      const schedule = [];
      let totalInterest = 0;

      for (let month = 1; month <= carryMonths; month++) {
        const row = { month };
        let monthTotal = 0;

        trancheAllocations.forEach((t, i) => {
          const monthlyInterest = t.allocated * (t.rate / 100) / 12;
          row[`tranche${i}`] = monthlyInterest;
          monthTotal += monthlyInterest;
        });

        // Default allocation interest
        const defaultInterest = defaultAllocation * (defaultRate / 100) / 12;
        row.default = defaultInterest;
        monthTotal += defaultInterest;

        row.total = monthTotal;
        totalInterest += monthTotal;
        schedule.push(row);
      }

      // Calculate total points cost
      let totalPoints = 0;
      trancheAllocations.forEach(t => {
        const pointsCost = t.allocated * ((t.points || 0) / 100);
        totalPoints += pointsCost;
      });

      // Update summary
      const summaryEl = document.getElementById('carrySummary');
      let summaryHtml = '';

      trancheAllocations.forEach(t => {
        if (t.allocated > 0) {
          const interest = t.allocated * (t.rate / 100) * (carryMonths / 12);
          const pointsCost = t.allocated * ((t.points || 0) / 100);
          const pointsLabel = t.points ? ` + ${t.points}pts` : '';
          summaryHtml += `
            <div class="carry-summary-row">
              <span class="label">${t.name} ($${t.allocated.toLocaleString()} @ ${t.rate}%${pointsLabel})</span>
              <span class="value">$${Math.round(interest + pointsCost).toLocaleString()}</span>
            </div>`;
        }
      });

      if (defaultAllocation > 0) {
        const defaultInterestTotal = defaultAllocation * (defaultRate / 100) * (carryMonths / 12);
        summaryHtml += `
          <div class="carry-summary-row">
            <span class="label">Remainder ($${defaultAllocation.toLocaleString()} @ ${defaultRate}%)</span>
            <span class="value">$${Math.round(defaultInterestTotal).toLocaleString()}</span>
          </div>`;
      }

      // Total carry = interest + points
      const totalCarryCost = totalInterest + totalPoints;

      // Blended rate calculation (interest only, not including points)
      const blendedRate = totalCashNeeded > 0 ? (totalInterest / carryMonths * 12 / totalCashNeeded * 100) : 0;

      summaryHtml += `
        <div class="carry-summary-row total">
          <span class="label">Total Carry Cost (${carryMonths} mo${totalPoints > 0 ? ' + points' : ''})</span>
          <span class="value">$${Math.round(totalCarryCost).toLocaleString()}</span>
        </div>
        <div class="carry-summary-row">
          <span class="label">Blended Rate</span>
          <span class="value">${blendedRate.toFixed(2)}%</span>
        </div>`;

      summaryEl.innerHTML = summaryHtml;

      // Update schedule table header
      const headerEl = document.getElementById('scheduleHeader');
      let headerHtml = '<th>Month</th>';
      trancheAllocations.forEach(t => {
        if (t.allocated > 0) headerHtml += `<th>${t.name}</th>`;
      });
      if (defaultAllocation > 0) headerHtml += '<th>Remainder</th>';
      headerHtml += '<th class="total-col">Total</th>';
      headerEl.innerHTML = headerHtml;

      // Update schedule table body
      const bodyEl = document.getElementById('scheduleBody');
      bodyEl.innerHTML = schedule.map(row => {
        let html = `<tr><td class="month-col">${row.month}</td>`;
        trancheAllocations.forEach((t, i) => {
          if (t.allocated > 0) html += `<td>$${Math.round(row[`tranche${i}`]).toLocaleString()}</td>`;
        });
        if (defaultAllocation > 0) html += `<td>$${Math.round(row.default).toLocaleString()}</td>`;
        html += `<td class="total-col">$${Math.round(row.total).toLocaleString()}</td></tr>`;
        return html;
      }).join('');

      // Update schedule table footer (totals)
      const footEl = document.getElementById('scheduleFoot');
      let footHtml = '<tr><td><strong>Total</strong></td>';
      trancheAllocations.forEach((t, i) => {
        if (t.allocated > 0) {
          const colTotal = schedule.reduce((sum, row) => sum + row[`tranche${i}`], 0);
          footHtml += `<td>$${Math.round(colTotal).toLocaleString()}</td>`;
        }
      });
      if (defaultAllocation > 0) {
        const defaultTotal = schedule.reduce((sum, row) => sum + row.default, 0);
        footHtml += `<td>$${Math.round(defaultTotal).toLocaleString()}</td>`;
      }
      footHtml += `<td class="total-col">$${Math.round(totalInterest).toLocaleString()}</td></tr>`;
      footEl.innerHTML = footHtml;

      // Carry Period Cash Flow Analysis
      const carryRentPercent = getVal('carryRentPercent') || 0;

      // Get monthly operating expenses (from main form)
      const annualGrossRent = (getVal('unit1Rent') + getVal('unit1Misc') +
                               getVal('unit2Rent') + getVal('unit2Misc') +
                               getVal('unit3Rent') + getVal('unit3Misc') +
                               getVal('unit4Rent') + getVal('unit4Misc')) * 12;

      // Calculate monthly expenses
      function getMonthlyExpense(field) {
        const val = getVal(field);
        const config = expenseConfig[field];
        if (config.mode === 'pct') {
          return (annualGrossRent * (val / 100)) / 12;
        } else {
          return config.freq === 'mo' ? val : val / 12;
        }
      }

      const monthlyExpenses = getMonthlyExpense('propTaxes') +
                              getMonthlyExpense('insurance') +
                              getMonthlyExpense('utilities');

      const monthlyRentPotential = (getVal('unit1Rent') + getVal('unit1Misc') +
                                    getVal('unit2Rent') + getVal('unit2Misc') +
                                    getVal('unit3Rent') + getVal('unit3Misc') +
                                    getVal('unit4Rent') + getVal('unit4Misc'));
      const monthlyRentCollected = monthlyRentPotential * (carryRentPercent / 100);
      const monthlyCarryInterest = totalInterest / carryMonths;

      const monthlyNetBurn = monthlyCarryInterest + monthlyExpenses - monthlyRentCollected;
      const totalCarryPeriodCost = monthlyNetBurn * carryMonths;

      const analysisEl = document.getElementById('carryPeriodAnalysis');
      const burnColor = monthlyNetBurn > 0 ? '#ef4444' : '#10b981';

      analysisEl.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-muted);">Monthly Carry Interest:</span>
            <span style="color: #ef4444;">-$${Math.round(monthlyCarryInterest).toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-muted);">Monthly Expenses:</span>
            <span style="color: #ef4444;">-$${Math.round(monthlyExpenses).toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-muted);">Monthly Rent (${carryRentPercent}%):</span>
            <span style="color: #10b981;">+$${Math.round(monthlyRentCollected).toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 4px; margin-top: 4px; font-weight: 600;">
            <span>Monthly Net:</span>
            <span style="color: ${burnColor};">${monthlyNetBurn > 0 ? '-' : '+'}$${Math.abs(Math.round(monthlyNetBurn)).toLocaleString()}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-weight: 600; background: var(--highlight); color: #fff; padding: 6px 8px; border-radius: 4px; margin-top: 4px;">
            <span>${carryMonths}mo Total:</span>
            <span style="color: ${monthlyNetBurn > 0 ? '#ef4444' : '#10b981'};">${totalCarryPeriodCost > 0 ? '-' : '+'}$${Math.abs(Math.round(totalCarryPeriodCost)).toLocaleString()}</span>
          </div>
        </div>
      `;

      // Update the summary text shown next to the button
      updateCarryButtonSummary();
    }

    function updateCarryButtonSummary() {
      const summaryEl = document.getElementById('carryTranchesSummary');
      if (carryTranches.length === 0) {
        summaryEl.textContent = '';
      } else {
        summaryEl.textContent = `(${carryTranches.length} tranche${carryTranches.length > 1 ? 's' : ''} configured)`;
      }
    }

    // JV Capital Recovery Modal Functions
    function openJvModal() {
      document.getElementById('jvModal').classList.add('open');
      populateJvInputs();
      updateJvResults();
    }

    function closeJvModal() {
      document.getElementById('jvModal').classList.remove('open');
      // Save JV config from inputs
      jvConfig.splitYou = parseFloat(document.getElementById('jvSplitYou').value) || 50;
      jvConfig.paybackMonths = parseInt(document.getElementById('jvPaybackMonths').value) || 6;
      jvConfig.refiMonth = parseInt(document.getElementById('jvRefiMonth').value) || 4;
      jvConfig.monthsToProject = parseInt(document.getElementById('jvMonthsToProject').value) || 60;
      // Sync split back to main input
      document.getElementById('jvSplitMain').value = jvConfig.splitYou;
      calculate(); // Recalculate with new split
      saveData();
    }

    function populateJvInputs() {
      // Get values from main DSCR calculation
      const purchasePrice = getVal('purchasePrice');
      const closingCost = getVal('closingCostDscr');
      const rehabCost = getVal('rehabCostDscr');
      const exitArv = getVal('exitArv');
      const dscrLtv = getVal('dscrLtv');
      const carryMonths = getVal('carryMonths');
      const interestRate = getVal('interestRate');
      const loanTerm = getVal('loanTerm');

      // Calculate cash in deal
      const totalCashNeeded = purchasePrice + closingCost + rehabCost;
      const carryAmount = getCarryCost();
      const totalCashIn = totalCashNeeded + carryAmount;
      const loanAmount = exitArv * (dscrLtv / 100);
      const cashLeftInDeal = totalCashIn - loanAmount;

      // Calculate pre-refi cash flow (NOI/12, no debt service during carry period)
      const unit1 = getVal('unit1Rent') + getVal('unit1Misc');
      const unit2 = getVal('unit2Rent') + getVal('unit2Misc');
      const unit3 = getVal('unit3Rent') + getVal('unit3Misc');
      const unit4 = getVal('unit4Rent') + getVal('unit4Misc');
      const grossMonthlyRent = unit1 + unit2 + unit3 + unit4;
      const vacancyRate = getVal('vacancyRate');
      const effectiveMonthlyRent = grossMonthlyRent * (1 - vacancyRate / 100);
      const annualEffectiveRent = effectiveMonthlyRent * 12;
      const annualGrossRent = grossMonthlyRent * 12;

      // Calculate expenses
      function calcExpenseYearly(field) {
        const val = getVal(field);
        const config = expenseConfig[field];
        if (config.mode === 'pct') {
          return annualGrossRent * (val / 100);
        } else {
          return config.freq === 'mo' ? val * 12 : val;
        }
      }

      const totalExpenses = calcExpenseYearly('propTaxes') + calcExpenseYearly('insurance') +
                            calcExpenseYearly('maintenance') + calcExpenseYearly('utilities') +
                            calcExpenseYearly('propMgmt') + calcExpenseYearly('capex') +
                            calcExpenseYearly('mortgageIns');

      const noi = annualEffectiveRent - totalExpenses;

      // Pre-refi CF: Rent - holding expenses - carry interest (matches carry modal)
      // Holding expenses = taxes + insurance + utilities (not maintenance/capex/mgmt during carry)
      const monthlyHoldingExpenses = (calcExpenseYearly('propTaxes') +
                                       calcExpenseYearly('insurance') +
                                       calcExpenseYearly('utilities')) / 12;
      const monthlyCarryInterest = carryAmount / carryMonths;
      const preRefiMonthlyCF = grossMonthlyRent - monthlyHoldingExpenses - monthlyCarryInterest;

      // Calculate post-refi cash flow (after DSCR loan in place)
      const monthlyPayment = calculateMortgage(loanAmount, interestRate, loanTerm);
      const annualDebtService = monthlyPayment * 12;
      const postRefiMonthlyCF = (noi - annualDebtService) / 12;

      // Populate readonly fields
      document.getElementById('jvCashIn').value = Math.round(Math.max(cashLeftInDeal, 0));
      document.getElementById('jvPreRefiCF').value = Math.round(preRefiMonthlyCF);
      document.getElementById('jvPostRefiCF').value = Math.round(postRefiMonthlyCF);

      // Populate editable fields - sync split from main input
      const mainSplit = getVal('jvSplitMain') || 100;
      document.getElementById('jvSplitYou').value = mainSplit;
      document.getElementById('jvPaybackMonths').value = jvConfig.paybackMonths;
      document.getElementById('jvRefiMonth').value = jvConfig.refiMonth;
      document.getElementById('jvMonthsToProject').value = jvConfig.monthsToProject;
    }

    function runJvSimulation(cashIn, preRefiCF, postRefiCF, refiMonth, paybackMonths, splitYou, monthsToProject) {
      const results = {
        months: [],
        dealCF: [],
        cashToYou: [],
        cashToOperator: [],
        remainingCapital: [],
        cumCashToYou: [],
        cumCashToOperator: []
      };

      let remainingCapital = cashIn;
      let cumCashToYou = 0;
      let cumCashToOperator = 0;
      let fullPaybackMonth = null;

      for (let month = 1; month <= monthsToProject; month++) {
        // Determine deal cash flow for the month
        const dealCF = (month <= refiMonth) ? preRefiCF : postRefiCF;

        let cashToYou = 0;
        let cashToOperator = 0;

        // Allocate cash flow
        if (month <= paybackMonths) {
          // During protection period - all CF goes to investor
          cashToYou = dealCF;
          cashToOperator = 0;
        } else {
          // After protection period - split by percentage
          cashToYou = dealCF * (splitYou / 100);
          cashToOperator = dealCF * (1 - splitYou / 100);
        }

        // Always reduce remaining capital by what goes to investor
        remainingCapital -= cashToYou;
        if (remainingCapital <= 0 && fullPaybackMonth === null) {
          fullPaybackMonth = month;
        }

        // Track cumulative totals
        cumCashToYou += cashToYou;
        cumCashToOperator += cashToOperator;

        // Store results
        results.months.push(month);
        results.dealCF.push(dealCF);
        results.cashToYou.push(cashToYou);
        results.cashToOperator.push(cashToOperator);
        results.remainingCapital.push(Math.max(remainingCapital, 0));
        results.cumCashToYou.push(cumCashToYou);
        results.cumCashToOperator.push(cumCashToOperator);
      }

      results.fullPaybackMonth = fullPaybackMonth;
      return results;
    }

    function updateJvResults() {
      // Get current values from inputs
      const cashIn = parseFloat(document.getElementById('jvCashIn').value) || 0;
      const preRefiCF = parseFloat(document.getElementById('jvPreRefiCF').value) || 0;
      const postRefiCF = parseFloat(document.getElementById('jvPostRefiCF').value) || 0;
      const refiMonth = parseInt(document.getElementById('jvRefiMonth').value) || 4;
      const paybackMonths = parseInt(document.getElementById('jvPaybackMonths').value) || 6;
      const splitYou = parseFloat(document.getElementById('jvSplitYou').value) || 50;
      const monthsToProject = parseInt(document.getElementById('jvMonthsToProject').value) || 60;

      // Run simulation
      jvResults = runJvSimulation(cashIn, preRefiCF, postRefiCF, refiMonth, paybackMonths, splitYou, monthsToProject);

      // Calculate display values
      const cashReturnedAtPayback = paybackMonths <= jvResults.cumCashToYou.length ?
        jvResults.cumCashToYou[paybackMonths - 1] : jvResults.cumCashToYou[jvResults.cumCashToYou.length - 1];

      const capitalRemaining = paybackMonths <= jvResults.remainingCapital.length ?
        jvResults.remainingCapital[paybackMonths - 1] : 0;

      const stabilizedMonthly = postRefiCF * (splitYou / 100);
      const stabilizedCoC = capitalRemaining > 0 ? (stabilizedMonthly * 12 / capitalRemaining) * 100 : 0;

      const totalToYou = jvResults.cumCashToYou[jvResults.cumCashToYou.length - 1] || 0;

      // Update display
      document.getElementById('jvCashReturned').textContent = '$' + Math.round(cashReturnedAtPayback).toLocaleString();
      document.getElementById('jvCapitalRemaining').textContent = '$' + Math.round(capitalRemaining).toLocaleString();
      document.getElementById('jvStabilizedMonthly').textContent = '$' + Math.round(stabilizedMonthly).toLocaleString();
      document.getElementById('jvStabilizedCoC').textContent = stabilizedCoC.toFixed(1) + '%';
      document.getElementById('jvFullPaybackMonth').textContent = jvResults.fullPaybackMonth ? jvResults.fullPaybackMonth : '--';
      document.getElementById('jvTotalToYou').textContent = '$' + Math.round(totalToYou).toLocaleString();

      // Generate phase breakdown
      let breakdownHtml = '';

      // Determine phases based on refi month and protection period
      if (refiMonth < paybackMonths) {
        // Phase 1: Pre-refi, 100% to you
        const phase1Months = refiMonth;
        const phase1Total = preRefiCF * phase1Months;
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #dcfce7; border-radius: 4px; margin-bottom: 4px;">
          <span><strong>Mo 1‚Äì${refiMonth}:</strong> $${Math.round(preRefiCF).toLocaleString()}/mo √ó ${phase1Months} = <strong>$${Math.round(phase1Total).toLocaleString()}</strong></span>
          <span style="color: #16a34a;">100% to you (pre-refi)</span>
        </div>`;

        // Phase 2: Post-refi, still 100% to you
        const phase2Months = paybackMonths - refiMonth;
        const phase2Total = postRefiCF * phase2Months;
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #dbeafe; border-radius: 4px; margin-bottom: 4px;">
          <span><strong>Mo ${refiMonth + 1}‚Äì${paybackMonths}:</strong> $${Math.round(postRefiCF).toLocaleString()}/mo √ó ${phase2Months} = <strong>$${Math.round(phase2Total).toLocaleString()}</strong></span>
          <span style="color: #2563eb;">100% to you (post-refi)</span>
        </div>`;

        // Phase 3: Split
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #fef3c7; border-radius: 4px;">
          <span><strong>Mo ${paybackMonths + 1}+:</strong> $${Math.round(postRefiCF).toLocaleString()}/mo √ó ${splitYou}% = <strong>$${Math.round(stabilizedMonthly).toLocaleString()}/mo</strong></span>
          <span style="color: #d97706;">${splitYou}% split begins</span>
        </div>`;
      } else if (refiMonth === paybackMonths) {
        // Refi and split happen same month
        const phase1Total = preRefiCF * refiMonth;
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #dcfce7; border-radius: 4px; margin-bottom: 4px;">
          <span><strong>Mo 1‚Äì${refiMonth}:</strong> $${Math.round(preRefiCF).toLocaleString()}/mo √ó ${refiMonth} = <strong>$${Math.round(phase1Total).toLocaleString()}</strong></span>
          <span style="color: #16a34a;">100% to you (pre-refi)</span>
        </div>`;
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #fef3c7; border-radius: 4px;">
          <span><strong>Mo ${paybackMonths + 1}+:</strong> $${Math.round(postRefiCF).toLocaleString()}/mo √ó ${splitYou}% = <strong>$${Math.round(stabilizedMonthly).toLocaleString()}/mo</strong></span>
          <span style="color: #d97706;">${splitYou}% split begins (post-refi)</span>
        </div>`;
      } else {
        // Refi happens after protection period ends
        const phase1Total = preRefiCF * paybackMonths;
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #dcfce7; border-radius: 4px; margin-bottom: 4px;">
          <span><strong>Mo 1‚Äì${paybackMonths}:</strong> $${Math.round(preRefiCF).toLocaleString()}/mo √ó ${paybackMonths} = <strong>$${Math.round(phase1Total).toLocaleString()}</strong></span>
          <span style="color: #16a34a;">100% to you (pre-refi)</span>
        </div>`;

        // Phase 2: Split but still pre-refi
        const phase2Months = refiMonth - paybackMonths;
        const phase2Monthly = preRefiCF * (splitYou / 100);
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #fef3c7; border-radius: 4px; margin-bottom: 4px;">
          <span><strong>Mo ${paybackMonths + 1}‚Äì${refiMonth}:</strong> $${Math.round(preRefiCF).toLocaleString()}/mo √ó ${splitYou}% = <strong>$${Math.round(phase2Monthly).toLocaleString()}/mo</strong></span>
          <span style="color: #d97706;">${splitYou}% split (pre-refi)</span>
        </div>`;

        // Phase 3: Split post-refi
        breakdownHtml += `<div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #e0e7ff; border-radius: 4px;">
          <span><strong>Mo ${refiMonth + 1}+:</strong> $${Math.round(postRefiCF).toLocaleString()}/mo √ó ${splitYou}% = <strong>$${Math.round(stabilizedMonthly).toLocaleString()}/mo</strong></span>
          <span style="color: #4f46e5;">${splitYou}% split (post-refi)</span>
        </div>`;
      }

      document.getElementById('jvPhaseBreakdown').innerHTML = breakdownHtml;

      // Render chart
      renderJvChart(jvResults);
    }

    function renderJvChart(results, comparisonResults = null) {
      const canvas = document.getElementById('jvChart');
      const ctx = canvas.getContext('2d');

      // Set canvas size
      canvas.width = canvas.parentElement.clientWidth - 24;
      canvas.height = 180;

      const padding = { top: 20, right: 20, bottom: 30, left: 60 };
      const w = canvas.width - padding.left - padding.right;
      const h = canvas.height - padding.top - padding.bottom;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (!results.remainingCapital || results.remainingCapital.length === 0) return;

      const maxVal = Math.max(...results.remainingCapital, ...(comparisonResults ? comparisonResults.remainingCapital : [0]));
      const maxMonth = results.months.length;

      // Grid lines
      ctx.strokeStyle = '#e2e8f0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (h / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();

        // Y-axis labels
        ctx.fillStyle = '#64748b';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        const val = maxVal - (maxVal / 4) * i;
        ctx.fillText('$' + Math.round(val / 1000) + 'k', padding.left - 5, y + 3);
      }

      // X-axis labels
      ctx.textAlign = 'center';
      const xLabels = [0, 12, 24, 36, 48, 60].filter(m => m <= maxMonth);
      xLabels.forEach(m => {
        const x = padding.left + (m / maxMonth) * w;
        ctx.fillText(m.toString(), x, canvas.height - 10);
      });

      // Draw comparison line first (if exists)
      if (comparisonResults) {
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 3]);
        ctx.beginPath();
        comparisonResults.remainingCapital.forEach((v, i) => {
          const x = padding.left + ((i + 1) / maxMonth) * w;
          const y = padding.top + h - (v / maxVal) * h;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Draw main line
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2;
      ctx.beginPath();
      results.remainingCapital.forEach((v, i) => {
        const x = padding.left + ((i + 1) / maxMonth) * w;
        const y = padding.top + h - (v / maxVal) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Fill under main line
      ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
      ctx.lineTo(padding.left + w, padding.top + h);
      ctx.lineTo(padding.left, padding.top + h);
      ctx.closePath();
      ctx.fill();

      // Draw payback period indicator
      const paybackMonths = parseInt(document.getElementById('jvPaybackMonths').value) || 6;
      const paybackX = padding.left + (paybackMonths / maxMonth) * w;
      ctx.setLineDash([4, 4]);
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(paybackX, padding.top);
      ctx.lineTo(paybackX, padding.top + h);
      ctx.stroke();
      ctx.setLineDash([]);

      // Label for payback period
      ctx.fillStyle = '#10b981';
      ctx.font = 'bold 9px sans-serif';
      ctx.fillText('Payback', paybackX, padding.top - 5);

      // Draw refi month indicator
      const refiMonth = parseInt(document.getElementById('jvRefiMonth').value) || 4;
      const refiX = padding.left + (refiMonth / maxMonth) * w;
      ctx.setLineDash([4, 4]);
      ctx.strokeStyle = '#ef4444';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(refiX, padding.top);
      ctx.lineTo(refiX, padding.top + h);
      ctx.stroke();
      ctx.setLineDash([]);

      // Label for refi
      ctx.fillStyle = '#ef4444';
      ctx.font = 'bold 9px sans-serif';
      ctx.fillText('Refi', refiX, padding.top - 5);
    }

    function compareJvScenarios() {
      const cashIn = parseFloat(document.getElementById('jvCashIn').value) || 0;
      const preRefiCF = parseFloat(document.getElementById('jvPreRefiCF').value) || 0;
      const postRefiCF = parseFloat(document.getElementById('jvPostRefiCF').value) || 0;
      const paybackMonths = parseInt(document.getElementById('jvPaybackMonths').value) || 6;
      const splitYou = parseFloat(document.getElementById('jvSplitYou').value) || 50;
      const monthsToProject = parseInt(document.getElementById('jvMonthsToProject').value) || 60;

      const refiMonth1 = parseInt(document.getElementById('jvCompareMonth1').value);
      const refiMonth2 = parseInt(document.getElementById('jvCompareMonth2').value);

      // Run simulations for both scenarios
      const results1 = runJvSimulation(cashIn, preRefiCF, postRefiCF, refiMonth1, paybackMonths, splitYou, monthsToProject);
      const results2 = runJvSimulation(cashIn, preRefiCF, postRefiCF, refiMonth2, paybackMonths, splitYou, monthsToProject);

      // Show legend
      document.getElementById('jvScenarioLegend').style.display = 'flex';
      document.getElementById('jvLegend1').textContent = 'Refi @ ' + refiMonth1;
      document.getElementById('jvLegend2').textContent = 'Refi @ ' + refiMonth2;

      // Render chart with comparison
      renderJvChart(results1, results2);
    }

    function resetJvDefaults() {
      jvConfig = {
        splitYou: 50,
        paybackMonths: 6,
        refiMonth: 4,
        monthsToProject: 60
      };
      document.getElementById('jvSplitYou').value = 50;
      document.getElementById('jvPaybackMonths').value = 6;
      document.getElementById('jvRefiMonth').value = 4;
      document.getElementById('jvMonthsToProject').value = 60;
      document.getElementById('jvScenarioLegend').style.display = 'none';
      updateJvResults();
    }

    function getCarryCost() {
      // Calculate total carry cost considering tranches (interest + points)
      const purchasePrice = getVal('purchasePrice');
      const closingCost = getVal('closingCostDscr');
      const rehabCost = getVal('rehabCostDscr');
      const carryMonths = getVal('carryMonths');
      const defaultRate = getVal('carryRate');

      const totalCashNeeded = purchasePrice + closingCost + rehabCost;

      if (carryTranches.length === 0) {
        // Simple calculation with default rate (no points)
        return totalCashNeeded * (defaultRate / 100) * (carryMonths / 12);
      }

      // Calculate with tranches
      let remaining = totalCashNeeded;
      let totalCarry = 0;
      let totalPoints = 0;

      carryTranches.forEach(t => {
        const allocated = Math.min(t.amount, remaining);
        remaining -= allocated;
        // Interest cost
        totalCarry += allocated * (t.rate / 100) * (carryMonths / 12);
        // Points cost (one-time fee)
        totalPoints += allocated * ((t.points || 0) / 100);
      });

      // Remaining at default rate (no points on remainder)
      totalCarry += remaining * (defaultRate / 100) * (carryMonths / 12);

      return totalCarry + totalPoints;
    }

    // Auto-save working state
    let autoSaveTimeout = null;

    function showToast(message = 'Auto-saved') {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function autoSave() {
      // Debounce auto-save to avoid too many writes
      if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        try {
          const workingState = gatherCurrentState();
          localStorage.setItem('propcalc_working', JSON.stringify(workingState));

          // If property has been saved, also update the vault
          if (currentPropertyId) {
            saveToVault();
          }
          showToast();
        } catch (e) {
          console.error('Auto-save error:', e);
        }
      }, 500);
    }

    function saveToVault() {
      // Save current state to the vault (saved properties)
      const sharedInputIds = [
        'propertyName', 'propertyAddress', 'purchasePrice', 'exitArv',
        'unit1Rent', 'unit1Misc', 'unit2Rent', 'unit2Misc',
        'unit3Rent', 'unit3Misc', 'unit4Rent', 'unit4Misc', 'vacancyRate',
        'propTaxes', 'insurance', 'maintenance', 'utilities', 'propMgmt', 'capex', 'mortgageIns',
        'utilElectric', 'utilGas', 'utilWater', 'utilTrash', 'utilLawn', 'utilOther',
        'appreciationRate', 'rentGrowth', 'costIncrease'
      ];
      const traditionalInputIds = ['downPercent', 'closingCost', 'rehabCost', 'interestRate', 'loanTerm'];
      const dscrInputIds = ['closingCostDscr', 'rehabCostDscr', 'dscrLtv', 'carryMonths', 'carryRate', 'carryRentPercent', 'interestRate', 'loanTerm', 'jvSplitMain'];

      const data = {
        name: document.getElementById('propertyName').value,
        lastModified: Date.now(),
        currentMode: currentMode,
        inputs: {},
        traditional: {},
        dscr: {},
        carryTranches: [...carryTranches],
        jvConfig: { ...jvConfig },
        expenseConfig: { ...expenseConfig }
      };

      sharedInputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) data.inputs[id] = el.value;
      });
      traditionalInputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) data.traditional[id] = el.value;
      });
      dscrInputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) data.dscr[id] = el.value;
      });

      localStorage.setItem(getStorageKey(currentPropertyId), JSON.stringify(data));
    }

    function gatherCurrentState() {
      // Gather all current input values
      const allInputIds = [
        'propertyName', 'propertyAddress', 'purchasePrice', 'exitArv',
        'unit1Rent', 'unit1Misc', 'unit2Rent', 'unit2Misc',
        'unit3Rent', 'unit3Misc', 'unit4Rent', 'unit4Misc', 'vacancyRate',
        'propTaxes', 'insurance', 'maintenance', 'utilities', 'propMgmt', 'capex', 'mortgageIns',
        'utilElectric', 'utilGas', 'utilWater', 'utilTrash', 'utilLawn', 'utilOther',
        'appreciationRate', 'rentGrowth', 'costIncrease',
        'downPercent', 'closingCost', 'rehabCost', 'interestRate', 'loanTerm',
        'closingCostDscr', 'rehabCostDscr', 'dscrLtv', 'carryMonths', 'carryRate', 'carryRentPercent', 'jvSplitMain'
      ];

      const inputs = {};
      allInputIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) inputs[id] = el.value;
      });

      return {
        currentPropertyId: currentPropertyId,
        currentMode: currentMode,
        inputs: inputs,
        carryTranches: [...carryTranches],
        jvConfig: { ...jvConfig },
        expenseConfig: { ...expenseConfig },
        lastModified: Date.now()
      };
    }

    function restoreWorkingState() {
      const saved = localStorage.getItem('propcalc_working');
      if (!saved) return false;

      try {
        const state = JSON.parse(saved);

        // Restore property ID
        currentPropertyId = state.currentPropertyId;

        // Restore all inputs
        Object.entries(state.inputs || {}).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.value = value;
        });

        // Restore expense config
        if (state.expenseConfig) {
          Object.assign(expenseConfig, state.expenseConfig);
          Object.entries(expenseConfig).forEach(([field, config]) => {
            document.querySelectorAll(`[data-field="${field}"]`).forEach(btn => {
              btn.classList.remove('active');
              if (btn.dataset.mode === config.mode || btn.dataset.freq === config.freq) {
                btn.classList.add('active');
              }
            });
            const input = document.getElementById(field);
            if (input) {
              const prefix = input.parentElement.querySelector('.input-prefix');
              if (prefix) prefix.textContent = config.mode === 'pct' ? '%' : '$';
            }
          });
        }

        // Restore carry tranches
        carryTranches = state.carryTranches || [];
        updateCarryButtonSummary();

        // Restore JV config
        if (state.jvConfig) {
          Object.assign(jvConfig, state.jvConfig);
        }

        // Update utility displays
        updateUtilityYearlyDisplays();

        // Restore mode
        setMode(state.currentMode || 'traditional');

        return true;
      } catch (e) {
        console.error('Error restoring working state:', e);
        return false;
      }
    }

    // Calculation functions
    function getVal(id) { return parseFloat(document.getElementById(id).value) || 0; }
    function setVal(id, val) { document.getElementById(id).textContent = val; }
    function fmt(n) { return '$' + Math.round(n).toLocaleString(); }
    function fmtPct(n) { return n.toFixed(2) + '%'; }
    function fmtCompact(n) {
      if (!n || n <= 0) return '---';
      if (n >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
      return '$' + Math.round(n / 1e3) + 'k';
    }

    // DSCR Indicator Update
    function updateDscrIndicator(dscrRatio, calcParams) {
      const indicator = document.getElementById('dscrIndicator');
      const status = document.getElementById('dscrStatus');
      const currentEl = document.getElementById('dscrTooltipCurrent');
      const metricEl = document.getElementById('dscrMetric');

      // Round to 2 decimals so tier logic matches displayed value
      dscrRatio = Math.round(dscrRatio * 100) / 100;

      // Clear previous active row
      document.querySelectorAll('.dscr-tooltip-row').forEach(row => row.classList.remove('active'));

      let emoji, statusText, colorClass, activeRowIndex, details;

      if (dscrRatio >= 1.25) {
        emoji = 'üü¢';
        statusText = 'Strong';
        colorClass = 'dscr-status-green';
        activeRowIndex = 0;
        details = 'Best rates & leverage. Minimal pushback.';
      } else if (dscrRatio >= 1.15) {
        emoji = 'üü°';
        statusText = 'Acceptable';
        colorClass = 'dscr-status-yellow';
        activeRowIndex = 1;
        details = 'Common approval range. Slightly higher rates.';
      } else if (dscrRatio >= 1.05) {
        emoji = 'üü†';
        statusText = 'Edge Case';
        colorClass = 'dscr-status-orange';
        activeRowIndex = 2;
        details = 'Expect lower LTV, higher rate, more reserves.';
      } else if (dscrRatio >= 1.00) {
        emoji = 'üî¥';
        statusText = 'Stretch';
        colorClass = 'dscr-status-red';
        activeRowIndex = 3;
        details = 'Case-by-case. Needs strong borrower profile.';
      } else {
        emoji = '‚ùå';
        statusText = 'No DSCR';
        colorClass = 'dscr-status-darkred';
        activeRowIndex = 4;
        details = 'Not financeable as DSCR. Consider bridge/hard money.';
      }

      indicator.textContent = emoji;
      status.textContent = statusText;
      status.className = 'sub ' + colorClass;

      // Highlight active row in tooltip
      const rows = document.querySelectorAll('.dscr-tooltip-row');
      if (rows[activeRowIndex]) {
        rows[activeRowIndex].classList.add('active');
      }

      // Update current status in tooltip
      currentEl.innerHTML = `<strong>Your DSCR: ${dscrRatio.toFixed(2)}</strong> ‚Äî ${details}`;

      // Update price ranges in tooltip
      const priceEls = document.querySelectorAll('.dscr-price-range');
      if (!calcParams || !priceEls.length) return;

      const { noi, interestRate, loanTerm, mode, ltvPct, downPct } = calcParams;
      const thresholds = [1.25, 1.15, 1.05, 1.00];

      // Edge cases: can't compute meaningful prices
      const divisor = mode === 'dscr' ? (ltvPct / 100) : (1 - downPct / 100);
      if (noi <= 0 || interestRate === 0 || divisor <= 0) {
        priceEls.forEach(el => el.textContent = '---');
        return;
      }

      const prices = thresholds.map(d => {
        const maxAds = noi / d;
        const maxPayment = maxAds / 12;
        const maxLoan = calculateMaxLoan(maxPayment, interestRate, loanTerm);
        return maxLoan / divisor;
      });

      // Green: ‚â§ price@1.25
      priceEls[0].textContent = '‚â§ ' + fmtCompact(prices[0]);
      // Yellow: price@1.25 ‚Äì price@1.15
      priceEls[1].textContent = fmtCompact(prices[0]) + ' ‚Äì ' + fmtCompact(prices[1]);
      // Orange: price@1.15 ‚Äì price@1.05
      priceEls[2].textContent = fmtCompact(prices[1]) + ' ‚Äì ' + fmtCompact(prices[2]);
      // Red: price@1.05 ‚Äì price@1.00
      priceEls[3].textContent = fmtCompact(prices[2]) + ' ‚Äì ' + fmtCompact(prices[3]);
      // Darkred: > price@1.00
      priceEls[4].textContent = '> ' + fmtCompact(prices[3]);
    }

    // Utility Breakdown Toggle
    let utilityExpanded = false;

    function toggleUtilityBreakdown() {
      utilityExpanded = !utilityExpanded;
      const toggle = document.querySelector('.expand-toggle');
      const details = document.querySelectorAll('.utility-detail');

      if (utilityExpanded) {
        toggle.classList.add('open');
        details.forEach(row => row.style.display = 'table-row');
      } else {
        toggle.classList.remove('open');
        details.forEach(row => row.style.display = 'none');
      }
    }

    function updateUtilityYearlyDisplays() {
      const electric = parseFloat(document.getElementById('utilElectric').value) || 0;
      const gas = parseFloat(document.getElementById('utilGas').value) || 0;
      const water = parseFloat(document.getElementById('utilWater').value) || 0;
      const trash = parseFloat(document.getElementById('utilTrash').value) || 0;
      const lawn = parseFloat(document.getElementById('utilLawn').value) || 0;
      const other = parseFloat(document.getElementById('utilOther').value) || 0;

      document.getElementById('utilElectricYearly').textContent = '$' + (electric * 12).toLocaleString();
      document.getElementById('utilGasYearly').textContent = '$' + (gas * 12).toLocaleString();
      document.getElementById('utilWaterYearly').textContent = '$' + (water * 12).toLocaleString();
      document.getElementById('utilTrashYearly').textContent = '$' + (trash * 12).toLocaleString();
      document.getElementById('utilLawnYearly').textContent = '$' + (lawn * 12).toLocaleString();
      document.getElementById('utilOtherYearly').textContent = '$' + (other * 12).toLocaleString();
    }

    function sumUtilities() {
      const electric = parseFloat(document.getElementById('utilElectric').value) || 0;
      const gas = parseFloat(document.getElementById('utilGas').value) || 0;
      const water = parseFloat(document.getElementById('utilWater').value) || 0;
      const trash = parseFloat(document.getElementById('utilTrash').value) || 0;
      const lawn = parseFloat(document.getElementById('utilLawn').value) || 0;
      const other = parseFloat(document.getElementById('utilOther').value) || 0;

      const total = electric + gas + water + trash + lawn + other;

      // Update yearly displays
      updateUtilityYearlyDisplays();

      // Update main utilities field if breakdown has values
      if (total > 0) {
        document.getElementById('utilities').value = total;
        // Make sure it's set to $ and MO mode
        expenseConfig.utilities.mode = 'dollar';
        expenseConfig.utilities.freq = 'mo';
      }

      calculate();
    }

    // Stress Test Calculation
    function runStressTest() {
      const tbody = document.getElementById('stressTestBody');
      if (!tbody) return;

      // Get current values
      const purchasePrice = getVal('purchasePrice');
      const exitArv = getVal('exitArv');
      const interestRate = getVal('interestRate');
      const loanTerm = getVal('loanTerm');
      const vacancyRate = getVal('vacancyRate');

      // Revenue
      const unit1 = getVal('unit1Rent') + getVal('unit1Misc');
      const unit2 = getVal('unit2Rent') + getVal('unit2Misc');
      const unit3 = getVal('unit3Rent') + getVal('unit3Misc');
      const unit4 = getVal('unit4Rent') + getVal('unit4Misc');
      const grossMonthlyRent = unit1 + unit2 + unit3 + unit4;
      const annualGrossRent = grossMonthlyRent * 12;

      // Calculate loan amount based on mode
      let loanAmount, cashBasis;
      if (currentMode === 'dscr') {
        const dscrLtv = getVal('dscrLtv');
        const closingCost = getVal('closingCostDscr');
        const rehabCost = getVal('rehabCostDscr');
        const carryAmount = getCarryCost();
        loanAmount = exitArv * (dscrLtv / 100);
        const totalCashIn = purchasePrice + closingCost + rehabCost + carryAmount;
        cashBasis = Math.max(totalCashIn - loanAmount, 1);
      } else {
        const downPct = getVal('downPercent');
        const closingCost = getVal('closingCost');
        const rehabCost = getVal('rehabCost');
        const downPayment = purchasePrice * (downPct / 100);
        loanAmount = purchasePrice - downPayment;
        cashBasis = downPayment + closingCost + rehabCost;
      }

      // JV Split
      const jvSplit = currentMode === 'dscr' ? (getVal('jvSplitMain') || 100) : 100;

      // Get base insurance value for display
      const baseInsurance = getVal('insurance');
      const insuranceConfig = expenseConfig.insurance;
      const baseInsuranceYearly = insuranceConfig.mode === 'pct'
        ? annualGrossRent * (baseInsurance / 100)
        : (insuranceConfig.freq === 'mo' ? baseInsurance * 12 : baseInsurance);

      // Helper to calculate expenses with optional insurance multiplier
      function calcTotalExpenses(grossRent, insuranceMultiplier = 1.0) {
        let total = 0;
        ['propTaxes', 'insurance', 'maintenance', 'utilities', 'propMgmt', 'capex', 'mortgageIns'].forEach(field => {
          const val = getVal(field);
          const config = expenseConfig[field];
          let expense;
          if (config.mode === 'pct') {
            expense = grossRent * (val / 100);
          } else {
            expense = config.freq === 'mo' ? val * 12 : val;
          }
          // Apply insurance multiplier
          if (field === 'insurance') {
            expense *= insuranceMultiplier;
          }
          total += expense;
        });
        return total;
      }

      // Helper to calculate metrics for a scenario
      function calcScenario(rentMultiplier, vacancyOverride, rateOverride, insuranceMultiplier = 1.0) {
        const adjGrossRent = annualGrossRent * rentMultiplier;
        const adjVacancy = vacancyOverride !== null ? vacancyOverride : vacancyRate;
        const adjRate = rateOverride !== null ? rateOverride : interestRate;

        const effectiveRent = adjGrossRent * (1 - adjVacancy / 100);
        const expenses = calcTotalExpenses(adjGrossRent, insuranceMultiplier);
        const noi = effectiveRent - expenses;

        const monthlyPayment = calculateMortgage(loanAmount, adjRate, loanTerm);
        const annualDebt = monthlyPayment * 12;

        const dscr = annualDebt > 0 ? noi / annualDebt : 0;
        const cashFlow = noi - annualDebt;
        const monthlyCF = (cashFlow / 12) * (jvSplit / 100);
        const coc = cashBasis > 0 ? ((cashFlow * (jvSplit / 100)) / cashBasis) * 100 : 0;

        return { dscr, monthlyCF, coc };
      }

      // Define scenarios
      const scenarios = [
        { name: 'üìç Base Case', rent: 1.0, vacancy: null, rate: null, insurance: 1.0, isBase: true },
        { name: 'üìâ Rent -10%', rent: 0.9, vacancy: null, rate: null, insurance: 1.0 },
        { name: 'üìâ Rent -20%', rent: 0.8, vacancy: null, rate: null, insurance: 1.0 },
        { name: 'üèöÔ∏è Vacancy 15%', rent: 1.0, vacancy: 15, rate: null, insurance: 1.0 },
        { name: 'üèöÔ∏è Vacancy 25%', rent: 1.0, vacancy: 25, rate: null, insurance: 1.0 },
        { name: 'üìà Interest +1% (' + (interestRate + 1).toFixed(1) + '%)', rent: 1.0, vacancy: null, rate: interestRate + 1, insurance: 1.0 },
        { name: 'üõ°Ô∏è Insurance 1.5x ($' + Math.round(baseInsuranceYearly * 1.5).toLocaleString() + '/yr)', rent: 1.0, vacancy: null, rate: null, insurance: 1.5 },
        { name: 'üõ°Ô∏è Insurance 2x ($' + Math.round(baseInsuranceYearly * 2).toLocaleString() + '/yr)', rent: 1.0, vacancy: null, rate: null, insurance: 2.0 },
        { name: 'üíÄ Worst: Rent -15%, Vac 20%, Ins 2x', rent: 0.85, vacancy: 20, rate: null, insurance: 2.0 },
      ];

      // Generate table rows
      let html = '';
      scenarios.forEach(s => {
        const result = calcScenario(s.rent, s.vacancy, s.rate, s.insurance || 1.0);

        // Determine status
        let status, statusClass;
        if (result.dscr >= 1.25) {
          status = '‚úì Strong';
          statusClass = 'status-pass';
        } else if (result.dscr >= 1.0) {
          status = '‚ö† Tight';
          statusClass = 'status-warn';
        } else {
          status = '‚úó Fail';
          statusClass = 'status-fail';
        }

        const cfClass = result.monthlyCF >= 0 ? 'value-positive' : 'value-negative';
        const cocClass = result.coc >= 0 ? 'value-positive' : 'value-negative';
        const rowClass = s.isBase ? 'base-case' : '';

        html += `<tr class="${rowClass}">
          <td class="scenario-name">${s.name}</td>
          <td>${result.dscr.toFixed(2)}</td>
          <td class="${cfClass}">$${Math.round(result.monthlyCF).toLocaleString()}</td>
          <td class="${cocClass}">${result.coc.toFixed(1)}%</td>
          <td class="${statusClass}">${status}</td>
        </tr>`;
      });

      tbody.innerHTML = html;
    }

    function calculateMortgage(principal, annualRate, years) {
      const monthlyRate = annualRate / 100 / 12;
      const n = years * 12;
      if (monthlyRate === 0) return principal / n;
      return principal * (monthlyRate * Math.pow(1 + monthlyRate, n)) / (Math.pow(1 + monthlyRate, n) - 1);
    }

    function calculateMaxLoan(maxMonthlyPayment, annualRate, years) {
      const monthlyRate = annualRate / 100 / 12;
      const n = years * 12;
      if (monthlyRate === 0) return maxMonthlyPayment * n;
      return maxMonthlyPayment * (Math.pow(1 + monthlyRate, n) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, n));
    }

    function getLoanBalance(principal, annualRate, years, monthsPaid) {
      const monthlyRate = annualRate / 100 / 12;
      const n = years * 12;
      if (monthlyRate === 0) return principal - (principal / n) * monthsPaid;
      const payment = calculateMortgage(principal, annualRate, years);
      return principal * Math.pow(1 + monthlyRate, monthsPaid) - payment * ((Math.pow(1 + monthlyRate, monthsPaid) - 1) / monthlyRate);
    }

    function calculate() {
      // Shared Acquisition inputs
      const purchasePrice = getVal('purchasePrice');
      const exitArv = getVal('exitArv');
      const interestRate = getVal('interestRate');
      const loanTerm = getVal('loanTerm');

      // Mode-specific calculations
      let loanAmount, totalOutOfPocket, cashBasis;

      if (currentMode === 'dscr') {
        // DSCR Mode: Cash purchase -> refinance at ARV * LTV%
        const closingCost = getVal('closingCostDscr');
        const rehabCost = getVal('rehabCostDscr');
        const dscrLtv = getVal('dscrLtv');
        const carryMonths = getVal('carryMonths');

        // Total cash needed upfront (buying all-cash)
        const totalCashNeeded = purchasePrice + closingCost + rehabCost;

        // Carry cost = interest only (uses tranches if configured)
        const carryAmount = getCarryCost();

        // Total cash invested before refi
        const totalCashIn = totalCashNeeded + carryAmount;

        // DSCR loan amount based on ARV
        loanAmount = exitArv * (dscrLtv / 100);

        // Cash back from refi
        const cashBack = loanAmount;

        // Cash left in deal (can be negative = cash out)
        const cashLeftInDeal = totalCashIn - cashBack;

        // For Cash-on-Cash, use absolute value of cash left (or small positive if cash out)
        cashBasis = cashLeftInDeal > 0 ? cashLeftInDeal : Math.abs(cashLeftInDeal);
        totalOutOfPocket = cashLeftInDeal; // For milestone calculations

        // Update DSCR highlight box
        setVal('dscrPurchase', fmt(purchasePrice));
        setVal('dscrFees', fmt(closingCost));
        setVal('dscrRehab', fmt(rehabCost));
        setVal('dscrCarry', fmt(carryAmount));

        setVal('dscrLoanAmount', fmt(loanAmount));
        setVal('dscrLtvDisplay', dscrLtv + '%');
        setVal('dscrArvDisplay', '$' + Math.round(exitArv / 1000) + 'k');

        // Update label and value based on whether cash out or cash in
        const labelEl = document.getElementById('dscrHighlightLabel');
        const valueEl = document.getElementById('dscrCashLeft');
        if (cashLeftInDeal < 0) {
          labelEl.textContent = 'Cash Out!';
          labelEl.className = 'label green';
          valueEl.textContent = fmt(Math.abs(cashLeftInDeal));
        } else {
          labelEl.textContent = 'Cash Left in Deal';
          labelEl.className = 'label';
          valueEl.textContent = fmt(cashLeftInDeal);
        }
      } else {
        // Traditional Mode: Standard mortgage
        const downPct = getVal('downPercent');
        const closingCost = getVal('closingCost');
        const rehabCost = getVal('rehabCost');

        const downPayment = purchasePrice * (downPct / 100);
        loanAmount = purchasePrice - downPayment;
        totalOutOfPocket = downPayment + closingCost + rehabCost;
        cashBasis = totalOutOfPocket;

        // Update Traditional highlight box
        setVal('downAmount', fmt(downPayment));
        setVal('feesAmount', fmt(closingCost));
        setVal('rehabAmount', fmt(rehabCost));
        setVal('totalOutOfPocket', fmt(totalOutOfPocket));
      }

      // Revenue
      const unit1 = getVal('unit1Rent') + getVal('unit1Misc');
      const unit2 = getVal('unit2Rent') + getVal('unit2Misc');
      const unit3 = getVal('unit3Rent') + getVal('unit3Misc');
      const unit4 = getVal('unit4Rent') + getVal('unit4Misc');
      const grossMonthlyRent = unit1 + unit2 + unit3 + unit4;
      const vacancyRate = getVal('vacancyRate');
      const effectiveMonthlyRent = grossMonthlyRent * (1 - vacancyRate / 100);
      const annualGrossRent = grossMonthlyRent * 12;

      setVal('totalMonthlyRevenue', fmt(grossMonthlyRent));

      // Expenses
      function calcExpense(field) {
        const val = getVal(field);
        const config = expenseConfig[field];
        let yearly;

        if (config.mode === 'pct') {
          yearly = annualGrossRent * (val / 100);
        } else {
          yearly = config.freq === 'mo' ? val * 12 : val;
        }

        setVal(field + 'Yearly', fmt(yearly));
        return yearly;
      }

      const propTaxes = calcExpense('propTaxes');
      const insurance = calcExpense('insurance');
      const maintenance = calcExpense('maintenance');
      const utilities = calcExpense('utilities');
      const propMgmt = calcExpense('propMgmt');
      const capex = calcExpense('capex');
      const mortgageIns = calcExpense('mortgageIns');

      const totalExpenses = propTaxes + insurance + maintenance + utilities + propMgmt + capex + mortgageIns;
      setVal('totalExpenses', fmt(totalExpenses));

      // NOI and Metrics
      const annualEffectiveRent = effectiveMonthlyRent * 12;
      const noi = annualEffectiveRent - totalExpenses;
      const monthlyPayment = calculateMortgage(loanAmount, interestRate, loanTerm);
      const annualDebtService = monthlyPayment * 12;
      const cashFlow = noi - annualDebtService;
      const monthlyCashFlow = cashFlow / 12;

      // DSCR ratio
      const dscrRatio = annualDebtService > 0 ? noi / annualDebtService : 0;
      setVal('dscr', dscrRatio.toFixed(2));
      updateDscrIndicator(dscrRatio, {
        noi,
        interestRate,
        loanTerm,
        mode: currentMode,
        ltvPct: currentMode === 'dscr' ? getVal('dscrLtv') : 0,
        downPct: currentMode !== 'dscr' ? getVal('downPercent') : 0,
      });

      // Cap Rate
      const capRate = purchasePrice > 0 ? (noi / purchasePrice) * 100 : 0;
      setVal('capRate', fmtPct(capRate));

      // Monthly Flow
      // Apply JV split in DSCR mode
      let displayMonthlyCF = monthlyCashFlow;
      let displayAnnualCF = cashFlow;
      const jvSplit = currentMode === 'dscr' ? (getVal('jvSplitMain') || 100) : 100;

      if (currentMode === 'dscr' && jvSplit < 100) {
        displayMonthlyCF = monthlyCashFlow * (jvSplit / 100);
        displayAnnualCF = cashFlow * (jvSplit / 100);
        // Show JV value with 100% value in parentheses
        setVal('monthlyFlow', fmt(displayMonthlyCF));
        document.getElementById('monthlyFlow').innerHTML = fmt(displayMonthlyCF) +
          '<span style="font-size:11px;color:var(--text-muted);font-weight:400;"> of ' + fmt(monthlyCashFlow) + '</span>';
      } else {
        setVal('monthlyFlow', fmt(displayMonthlyCF));
      }

      // Cash on Cash (use cashBasis which differs by mode)
      const cashOnCash = cashBasis > 0 ? (displayAnnualCF / cashBasis) * 100 : 0;
      const fullCashOnCash = cashBasis > 0 ? (cashFlow / cashBasis) * 100 : 0;

      if (currentMode === 'dscr' && jvSplit < 100) {
        document.getElementById('cashOnCash').innerHTML = fmtPct(cashOnCash) +
          '<span style="font-size:11px;color:var(--text-muted);font-weight:400;"> of ' + fmtPct(fullCashOnCash) + '</span>';
      } else {
        setVal('cashOnCash', fmtPct(cashOnCash));
      }

      // Growth rates from inputs
      const appreciationRate = getVal('appreciationRate') / 100;
      const rentGrowthRate = getVal('rentGrowth') / 100;
      const costIncreaseRate = getVal('costIncrease') / 100;

      // Calculate cumulative cash flow with growth
      function getCumulativeFlow(years) {
        let total = 0;
        let yearlyRent = annualEffectiveRent;
        let yearlyExp = totalExpenses;
        for (let y = 1; y <= years; y++) {
          if (y > 1) {
            yearlyRent *= (1 + rentGrowthRate);
            yearlyExp *= (1 + costIncreaseRate);
          }
          const yearNoi = yearlyRent - yearlyExp;
          const yearCashFlow = yearNoi - annualDebtService;
          total += yearCashFlow;
        }
        return total;
      }

      // For milestones, use totalOutOfPocket (can be negative in DSCR cash-out)
      const basisForGain = currentMode === 'dscr' ? Math.max(totalOutOfPocket, 0) : totalOutOfPocket;

      // Year 5
      const value5 = exitArv * Math.pow(1 + appreciationRate, 5);
      const balance5 = getLoanBalance(loanAmount, interestRate, loanTerm, 60);
      const equity5 = value5 - balance5;
      const flow5 = getCumulativeFlow(5);
      const netGain5 = equity5 + flow5 - basisForGain;

      setVal('equity5', fmt(equity5));
      setVal('debt5', fmt(balance5));
      setVal('flow5', (flow5 >= 0 ? '+' : '') + fmt(flow5));
      setVal('netGain5', fmt(netGain5));

      // Year 10
      const value10 = exitArv * Math.pow(1 + appreciationRate, 10);
      const balance10 = getLoanBalance(loanAmount, interestRate, loanTerm, 120);
      const equity10 = value10 - balance10;
      const flow10 = getCumulativeFlow(10);
      const netGain10 = equity10 + flow10 - basisForGain;

      setVal('equity10', fmt(equity10));
      setVal('debt10', fmt(balance10));
      setVal('flow10', (flow10 >= 0 ? '+' : '') + fmt(flow10));
      setVal('netGain10', fmt(netGain10));

      // Update chart
      updateChart(exitArv, loanAmount, interestRate, loanTerm, appreciationRate);

      // Run stress test
      runStressTest();

      // Auto-save working state
      autoSave();
    }

    // Chart
    let chartData = { assets: [], loans: [], maxVal: 0, padding: {}, w: 0, h: 0 };

    function updateChart(arv, loanAmount, rate, term, appreciation) {
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');

      // Set canvas size
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = 150;

      const years = [];
      const assets = [];
      const loans = [];

      for (let y = 0; y <= 30; y++) {
        years.push(y);
        assets.push(arv * Math.pow(1 + appreciation, y));
        loans.push(y * 12 <= term * 12 ? getLoanBalance(loanAmount, rate, term, y * 12) : 0);
      }

      const maxVal = Math.max(...assets, ...loans);
      const padding = { top: 20, right: 20, bottom: 30, left: 50 };
      const w = canvas.width - padding.left - padding.right;
      const h = canvas.height - padding.top - padding.bottom;

      // Store for tooltip
      chartData = { assets, loans, maxVal, padding, w, h, canvas };

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Grid lines
      ctx.strokeStyle = '#e2e8f0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding.top + (h / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();

        // Y-axis labels
        ctx.fillStyle = '#64748b';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'right';
        const val = maxVal - (maxVal / 4) * i;
        ctx.fillText('$' + Math.round(val / 1000) + 'k', padding.left - 5, y + 3);
      }

      // X-axis labels
      ctx.textAlign = 'center';
      [0, 5, 10, 15, 20, 25, 30].forEach(y => {
        const x = padding.left + (y / 30) * w;
        ctx.fillText(y.toString(), x, canvas.height - 10);
      });

      // Year 5 and 10 indicator lines
      ctx.setLineDash([4, 4]);
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 1;
      [5, 10].forEach(year => {
        const x = padding.left + (year / 30) * w;
        ctx.beginPath();
        ctx.moveTo(x, padding.top);
        ctx.lineTo(x, padding.top + h);
        ctx.stroke();

        // Label
        ctx.fillStyle = '#10b981';
        ctx.font = 'bold 9px sans-serif';
        ctx.fillText('Y' + year, x, padding.top - 5);
      });
      ctx.setLineDash([]);

      // Asset line
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2;
      ctx.beginPath();
      assets.forEach((v, i) => {
        const x = padding.left + (i / 30) * w;
        const y = padding.top + h - (v / maxVal) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Fill under asset line
      ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
      ctx.lineTo(padding.left + w, padding.top + h);
      ctx.lineTo(padding.left, padding.top + h);
      ctx.closePath();
      ctx.fill();

      // Loan line
      ctx.strokeStyle = '#ef4444';
      ctx.lineWidth = 2;
      ctx.beginPath();
      loans.forEach((v, i) => {
        const x = padding.left + (i / 30) * w;
        const y = padding.top + h - (v / maxVal) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Draw dots at year 5 and 10
      [5, 10].forEach(year => {
        const x = padding.left + (year / 30) * w;
        const assetY = padding.top + h - (assets[year] / maxVal) * h;
        const loanY = padding.top + h - (loans[year] / maxVal) * h;

        // Asset dot
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(x, assetY, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Loan dot
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.arc(x, loanY, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      });
    }

    // Chart tooltip handling
    function setupChartTooltip() {
      const canvas = document.getElementById('chart');
      const tooltip = document.getElementById('chartTooltip');

      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const { assets, loans, maxVal, padding, w, h } = chartData;
        if (!assets.length) return;

        // Check if in chart area
        if (x < padding.left || x > padding.left + w || y < padding.top || y > padding.top + h) {
          tooltip.classList.remove('visible');
          return;
        }

        // Calculate year from x position
        const year = Math.round((x - padding.left) / w * 30);
        if (year < 0 || year > 30) {
          tooltip.classList.remove('visible');
          return;
        }

        const assetVal = assets[year];
        const loanVal = loans[year];
        const equity = assetVal - loanVal;

        tooltip.innerHTML = `
          <div class="tt-year">Year ${year}</div>
          <div class="tt-row">
            <span class="tt-label">Asset Value</span>
            <span class="tt-value asset">$${Math.round(assetVal).toLocaleString()}</span>
          </div>
          <div class="tt-row">
            <span class="tt-label">Loan Balance</span>
            <span class="tt-value loan">$${Math.round(loanVal).toLocaleString()}</span>
          </div>
          <div class="tt-row">
            <span class="tt-label">Equity</span>
            <span class="tt-value equity">$${Math.round(equity).toLocaleString()}</span>
          </div>
        `;

        // Position tooltip
        let tooltipX = x + 15;
        let tooltipY = y - 10;

        // Keep tooltip in bounds
        const tooltipRect = tooltip.getBoundingClientRect();
        const containerRect = canvas.parentElement.getBoundingClientRect();

        if (tooltipX + 150 > containerRect.width) {
          tooltipX = x - 160;
        }

        tooltip.style.left = tooltipX + 'px';
        tooltip.style.top = tooltipY + 'px';
        tooltip.classList.add('visible');
      });

      canvas.addEventListener('mouseleave', () => {
        tooltip.classList.remove('visible');
      });
    }

    // Local Storage - Namespaced by property
    function getStorageKey(propertyId) {
      return 'propcalc_' + propertyId;
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function getAllProperties() {
      const properties = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        // Exclude working state - only get saved properties
        if (key.startsWith('propcalc_') && key !== 'propcalc_working') {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data && data.name) {
              properties.push({ id: key.replace('propcalc_', ''), ...data });
            }
          } catch (e) {
            console.error('Error parsing property:', key, e);
          }
        }
      }
      return properties.sort((a, b) => (b.lastModified || 0) - (a.lastModified || 0));
    }

    function saveData() {
      if (!currentPropertyId) {
        currentPropertyId = generateId();
      }

      saveToVault();

      // Update working state with the property ID so auto-save knows where to go
      const workingState = gatherCurrentState();
      localStorage.setItem('propcalc_working', JSON.stringify(workingState));

      // Visual feedback
      const btn = document.querySelector('.btn-save');
      const original = btn.innerHTML;
      btn.innerHTML = '‚úì Saved';
      setTimeout(() => btn.innerHTML = original, 1500);
    }

    function loadProperty(propertyId) {
      const data = JSON.parse(localStorage.getItem(getStorageKey(propertyId)));
      if (!data) return;

      currentPropertyId = propertyId;

      // Restore shared inputs
      Object.entries(data.inputs || {}).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      });

      // Restore traditional-specific inputs
      Object.entries(data.traditional || {}).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      });

      // Restore DSCR-specific inputs
      Object.entries(data.dscr || {}).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      });

      // Restore expense config
      if (data.expenseConfig) {
        Object.assign(expenseConfig, data.expenseConfig);

        // Update toggle buttons to match
        Object.entries(expenseConfig).forEach(([field, config]) => {
          document.querySelectorAll(`[data-field="${field}"]`).forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.mode === config.mode || btn.dataset.freq === config.freq) {
              btn.classList.add('active');
            }
          });

          // Update prefix
          const input = document.getElementById(field);
          if (input) {
            const prefix = input.parentElement.querySelector('.input-prefix');
            if (prefix) prefix.textContent = config.mode === 'pct' ? '%' : '$';
          }
        });
      }

      // Restore carry tranches
      carryTranches = data.carryTranches || [];
      updateCarryButtonSummary();

      // Update utility breakdown yearly displays
      updateUtilityYearlyDisplays();

      // Restore JV config
      if (data.jvConfig) {
        Object.assign(jvConfig, data.jvConfig);
      } else {
        // Reset to defaults if not present
        jvConfig = { splitYou: 50, paybackMonths: 6, refiMonth: 4, monthsToProject: 60 };
      }

      // Restore mode (default to traditional for backwards compatibility)
      setMode(data.currentMode || 'traditional');

      hideVault();
    }

    function newProperty() {
      currentPropertyId = null;
      // Clear working state so we start fresh
      localStorage.removeItem('propcalc_working');

      document.getElementById('propertyName').value = 'New Property Analysis';
      document.getElementById('propertyAddress').value = '';

      // Reset to defaults - shared inputs
      const sharedDefaults = {
        purchasePrice: '', exitArv: '',
        unit1Rent: '', unit1Misc: '', unit2Rent: '', unit2Misc: '',
        unit3Rent: '', unit3Misc: '', unit4Rent: '', unit4Misc: '',
        vacancyRate: '', propTaxes: '', insurance: '', maintenance: '',
        utilities: '', propMgmt: '', capex: '', mortgageIns: '',
        utilElectric: '', utilGas: '', utilWater: '', utilTrash: '', utilLawn: '', utilOther: '',
        appreciationRate: '', rentGrowth: '', costIncrease: ''
      };

      // Traditional defaults
      const traditionalDefaults = {
        downPercent: '', closingCost: '', rehabCost: '',
        interestRate: '', loanTerm: 30
      };

      // DSCR defaults
      const dscrDefaults = {
        closingCostDscr: '', rehabCostDscr: '',
        dscrLtv: '', carryMonths: '', carryRate: '', carryRentPercent: '',
        jvSplitMain: 100
      };

      // Apply all defaults
      Object.entries(sharedDefaults).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      });

      Object.entries(traditionalDefaults).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      });

      Object.entries(dscrDefaults).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.value = value;
      });

      // Clear carry tranches
      carryTranches = [];
      updateCarryButtonSummary();

      // Reset JV config
      jvConfig = { splitYou: 50, paybackMonths: 6, refiMonth: 4, monthsToProject: 60 };

      // Reset to Traditional mode
      setMode('traditional');
    }

    function deleteProperty() {
      if (!currentPropertyId) return;
      if (!confirm('Delete this property analysis?')) return;

      localStorage.removeItem(getStorageKey(currentPropertyId));
      newProperty();
    }

    function exportToFile() {
      // Save current state first
      saveData();

      // Get the data
      const data = JSON.parse(localStorage.getItem(getStorageKey(currentPropertyId)));
      if (!data) {
        alert('No data to export. Save the property first.');
        return;
      }

      // Add export metadata
      data.exportedAt = new Date().toISOString();
      data.version = '1.0';

      // Create filename from property name
      const filename = (data.name || 'property').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.json';

      // Create and download file
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Visual feedback
      const btn = document.querySelector('.btn-pdf');
      const original = btn.innerHTML;
      btn.innerHTML = '‚úì Exported';
      setTimeout(() => btn.innerHTML = original, 1500);
    }

    function importFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);

          // Validate it looks like our data format
          if (!data.inputs && !data.name) {
            alert('Invalid file format. This doesn\'t appear to be a PropCalc export.');
            return;
          }

          // Generate new ID for imported property
          const newId = generateId();

          // Update metadata
          data.lastModified = Date.now();
          data.name = (data.name || 'Imported') + ' (Imported)';
          if (data.inputs) {
            data.inputs.propertyName = data.name;
          }

          // Save to localStorage
          localStorage.setItem(getStorageKey(newId), JSON.stringify(data));

          // Load the imported property
          loadProperty(newId);

          alert('Property imported successfully!');
        } catch (err) {
          alert('Error reading file: ' + err.message);
        }
      };
      reader.readAsText(file);

      // Reset file input so same file can be imported again
      event.target.value = '';
    }

    function duplicateProperty() {
      // Save current property first to ensure latest data
      saveData();

      // Load existing data
      const existingData = JSON.parse(localStorage.getItem(getStorageKey(currentPropertyId)));
      if (!existingData) {
        // If no saved data, just save current state as new
        currentPropertyId = null;
        const nameEl = document.getElementById('propertyName');
        nameEl.value = nameEl.value + ' (Copy)';
        saveData();
        return;
      }

      // Generate new ID for duplicate
      const newId = generateId();

      // Create duplicate with modified name
      const duplicateData = {
        ...existingData,
        name: (existingData.name || 'Untitled') + ' (Copy)',
        lastModified: Date.now()
      };

      // Also update the inputs.propertyName if it exists
      if (duplicateData.inputs && duplicateData.inputs.propertyName) {
        duplicateData.inputs.propertyName = duplicateData.name;
      }

      // Save duplicate
      localStorage.setItem(getStorageKey(newId), JSON.stringify(duplicateData));

      // Load the duplicate
      loadProperty(newId);

      // Visual feedback
      const btn = document.querySelector('.btn-duplicate');
      const original = btn.innerHTML;
      btn.innerHTML = '‚úì Duplicated';
      setTimeout(() => btn.innerHTML = original, 1500);
    }

    // Settings Modal
    function openSettings() {
      // Load saved settings
      const savedKey = localStorage.getItem('propcalc_openai_key') || '';
      const savedModel = localStorage.getItem('propcalc_openai_model') || 'gpt-4o-mini';
      document.getElementById('openaiKey').value = savedKey;
      document.getElementById('openaiModel').value = savedModel;
      document.getElementById('settingsModal').classList.add('open');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('open');
    }

    function saveSettings() {
      const key = document.getElementById('openaiKey').value.trim();
      const model = document.getElementById('openaiModel').value;
      localStorage.setItem('propcalc_openai_key', key);
      localStorage.setItem('propcalc_openai_model', model);
      closeSettings();
      alert('Settings saved!');
    }

    // AI Chat
    let aiChatHistory = [];

    function openAiChat() {
      const apiKey = localStorage.getItem('propcalc_openai_key');
      if (!apiKey) {
        alert('Please configure your OpenAI API key in Settings first.');
        openSettings();
        return;
      }
      document.getElementById('aiModal').classList.add('open');
      document.getElementById('aiInput').focus();
    }

    function closeAiChat() {
      document.getElementById('aiModal').classList.remove('open');
    }

    function getDealSummary() {
      // Gather all current deal data for AI context
      const mode = currentMode;
      const propertyName = document.getElementById('propertyName').value;
      const address = document.getElementById('propertyAddress').value;
      const purchasePrice = getVal('purchasePrice');
      const exitArv = getVal('exitArv');

      // Revenue
      const unit1 = getVal('unit1Rent') + getVal('unit1Misc');
      const unit2 = getVal('unit2Rent') + getVal('unit2Misc');
      const unit3 = getVal('unit3Rent') + getVal('unit3Misc');
      const unit4 = getVal('unit4Rent') + getVal('unit4Misc');
      const totalRent = unit1 + unit2 + unit3 + unit4;
      const vacancy = getVal('vacancyRate');

      // Expenses
      const propTaxes = document.getElementById('propTaxesYearly').textContent;
      const insurance = document.getElementById('insuranceYearly').textContent;
      const maintenance = document.getElementById('maintenanceYearly').textContent;
      const utilities = document.getElementById('utilitiesYearly').textContent;
      const totalExpenses = document.getElementById('totalExpenses').textContent;

      // Metrics
      const dscr = document.getElementById('dscr').textContent;
      const capRate = document.getElementById('capRate').textContent;
      const monthlyFlow = document.getElementById('monthlyFlow').textContent;
      const cashOnCash = document.getElementById('cashOnCash').textContent;

      // Mode specific
      let modeDetails = '';
      if (mode === 'dscr') {
        const cashLeft = document.getElementById('dscrCashLeft').textContent;
        const loanAmount = document.getElementById('dscrLoanAmount').textContent;
        const ltv = getVal('dscrLtv');
        const carryMonths = getVal('carryMonths');
        const jvSplit = getVal('jvSplitMain');
        modeDetails = `
DSCR Mode Details:
- Cash Left in Deal: ${cashLeft}
- DSCR Loan Amount: ${loanAmount}
- LTV: ${ltv}%
- Carry Period: ${carryMonths} months
- JV Split (Your %): ${jvSplit}%`;
      } else {
        const downPct = getVal('downPercent');
        const totalOop = document.getElementById('totalOutOfPocket').textContent;
        modeDetails = `
Traditional Mode Details:
- Down Payment: ${downPct}%
- Total Out of Pocket: ${totalOop}`;
      }

      return `
PROPERTY ANALYSIS: ${propertyName}
Address: ${address || 'Not specified'}
Mode: ${mode.toUpperCase()}

ACQUISITION:
- Purchase Price: $${purchasePrice.toLocaleString()}
- Exit ARV: $${exitArv.toLocaleString()}
${modeDetails}

REVENUE:
- Monthly Rent: $${totalRent.toLocaleString()} (${[unit1, unit2, unit3, unit4].filter(u => u > 0).length} units)
- Vacancy Rate: ${vacancy}%

EXPENSES (Annual):
- Property Taxes: ${propTaxes}
- Insurance: ${insurance}
- Maintenance: ${maintenance}
- Utilities: ${utilities}
- Total Operating Expenses: ${totalExpenses}

KEY METRICS:
- DSCR: ${dscr}
- Cap Rate: ${capRate}
- Monthly Cash Flow: ${monthlyFlow}
- Cash-on-Cash Return: ${cashOnCash}
`;
    }

    async function sendAiMessage() {
      const input = document.getElementById('aiInput');
      const message = input.value.trim();
      if (!message) return;

      const apiKey = localStorage.getItem('propcalc_openai_key');
      const model = localStorage.getItem('propcalc_openai_model') || 'gpt-4o-mini';

      if (!apiKey) {
        alert('Please configure your OpenAI API key in Settings.');
        return;
      }

      // Add user message to chat
      const messagesDiv = document.getElementById('aiMessages');
      messagesDiv.innerHTML += `<div class="ai-message user"><div class="bubble">${escapeHtml(message)}</div></div>`;
      input.value = '';

      // Show typing indicator
      const typingId = 'typing-' + Date.now();
      messagesDiv.innerHTML += `<div class="ai-message assistant" id="${typingId}"><div class="bubble ai-typing">Thinking...</div></div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      // Disable send button
      document.getElementById('aiSendBtn').disabled = true;

      // Build messages array
      if (aiChatHistory.length === 0) {
        aiChatHistory.push({
          role: 'system',
          content: `You are a helpful real estate investment advisor. You have access to the user's current property analysis. Be concise but thorough. Use numbers from the deal when relevant. Here is the current deal data:\n${getDealSummary()}`
        });
      }

      aiChatHistory.push({ role: 'user', content: message });

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: model,
            messages: aiChatHistory,
            max_tokens: 1000
          })
        });

        const data = await response.json();

        // Remove typing indicator
        document.getElementById(typingId)?.remove();

        if (data.error) {
          messagesDiv.innerHTML += `<div class="ai-message system"><div class="bubble">Error: ${data.error.message}</div></div>`;
        } else {
          const reply = data.choices[0].message.content;
          aiChatHistory.push({ role: 'assistant', content: reply });
          messagesDiv.innerHTML += `<div class="ai-message assistant"><div class="bubble">${formatAiResponse(reply)}</div></div>`;
        }
      } catch (err) {
        document.getElementById(typingId)?.remove();
        messagesDiv.innerHTML += `<div class="ai-message system"><div class="bubble">Error: ${err.message}</div></div>`;
      }

      document.getElementById('aiSendBtn').disabled = false;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatAiResponse(text) {
      // Convert markdown-like formatting to HTML
      return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    function showVault() {
      try {
        console.log('showVault called');
        const modal = document.getElementById('vaultModal');
        console.log('modal:', modal);
        const list = document.getElementById('vaultList');
        console.log('list:', list);
        const properties = getAllProperties();
        console.log('Properties found:', properties.length);
        console.log('Modal display before:', modal.style.display);

      if (properties.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px;">No saved properties yet.</p>';
      } else {
        list.innerHTML = properties.map(p => `
          <div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;transition:background 0.15s;" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='transparent'">
            <div onclick="loadProperty('${p.id}')" style="cursor:pointer;flex:1;">
              <div style="font-weight:600;">${p.name || 'Untitled'}</div>
              <div style="font-size:11px;color:var(--text-muted);">Last modified: ${new Date(p.lastModified).toLocaleDateString()}</div>
            </div>
            <button onclick="deleteVaultItem('${p.id}', '${(p.name || 'Untitled').replace(/'/g, "\\'")}')" style="border:none;background:none;color:#ef4444;cursor:pointer;padding:8px;font-size:16px;" title="Delete">üóëÔ∏è</button>
          </div>
        `).join('');
      }

      modal.style.display = 'flex';
      console.log('Modal display after:', modal.style.display);
      } catch(e) {
        console.error('showVault error:', e);
      }
    }

    function hideVault() {
      document.getElementById('vaultModal').style.display = 'none';
    }

    function deleteVaultItem(id, name) {
      if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
      localStorage.removeItem(getStorageKey(id));
      // If we deleted the current property, clear the ID
      if (currentPropertyId === id) {
        currentPropertyId = null;
      }
      // Refresh the vault list
      showVault();
      showToast('Property deleted');
    }

    // Close modal on backdrop click
    document.getElementById('vaultModal').addEventListener('click', function(e) {
      if (e.target === this) hideVault();
    });

    // Initialize
    window.addEventListener('load', () => {
      // Setup chart tooltip
      setupChartTooltip();

      // Try to restore working state first (last session's state)
      if (restoreWorkingState()) {
        // Working state restored successfully
        return;
      }

      // Fall back to loading most recent saved property
      const properties = getAllProperties();
      if (properties.length > 0) {
        loadProperty(properties[0].id);
      } else {
        calculate();
      }
    });

    window.addEventListener('resize', calculate);
  </script>
</body>
</html>
